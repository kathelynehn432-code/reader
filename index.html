
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SoulReader V33 (æ¸…é€ä¿®å¤ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        :root { 
            --bg: #f8f5e6; 
            --accent: #d35400; --text: #2c3e50; 
            --mark-bg: #ffeaa7; --ai-bubble: #ffffff; --user-bubble: #e17055; 
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        /* ğŸš€ ä¿®å¤æ»‘åŠ¨ Bug çš„æ ¸å¿ƒä»£ç ï¼šé”å®šè§†å£ç»å¯¹å°ºå¯¸ */
        body { 
            font-family: 'PingFang SC', serif; 
            margin: 0; 
            position: fixed; /* é”å®šå±å¹•ï¼Œé˜²æ­¢æµè§ˆå™¨ç½‘å€æ ä¼¸ç¼©å¯¼è‡´é”™ä½ */
            inset: 0; 
            overflow: hidden; 
            background: var(--bg); 
            color: var(--text); 
            display: flex; 
            flex-direction: column; 
            padding-top: max(10px, env(safe-area-inset-top)); /* é¡¶éƒ¨ç•™ç™½ï¼Œç»ä¸è´´è¾¹ */
        }
        
        /* ğŸ“± æ‚¬æµ®æ¯›ç»ç’ƒèƒ¶å›Šå¯¼èˆª */
        #tab-bar { 
            position: fixed; 
            bottom: max(20px, calc(15px + var(--safe-bottom))); 
            left: 50%; 
            transform: translateX(-50%); 
            width: 90%; 
            max-width: 400px; 
            height: 65px; 
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px); 
            border: 1px solid rgba(255,255,255,0.8); 
            border-radius: 35px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.06); 
            display: flex; 
            justify-content: space-around; 
            align-items: center; 
            z-index: 900; 
        }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #888; flex: 1; height: 100%; justify-content: center; transition: all 0.2s; }
        .tab-item:active { transform: scale(0.9); }
        .tab-item.active { color: #222; font-weight: bold; }
        .tab-icon { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2.2; margin-bottom: 3px; }

        #main-view { flex: 1; overflow: hidden; position: relative; }
        .view-page { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); overflow-y: auto; -webkit-overflow-scrolling: touch; padding-bottom: 120px; }
        .view-page.active { display: flex; }

        input, select, textarea { width: 100%; border: none; background: rgba(255,255,255,0.6); border-radius: 12px; padding: 12px 15px; font-size: 15px; font-family: inherit; margin-top: 5px; transition: all 0.3s; box-shadow: 0 2px 10px rgba(0,0,0,0.02); }
        input:focus, select:focus, textarea:focus { outline: none; background: #fff; box-shadow: 0 4px 15px rgba(0,0,0,0.05), 0 0 0 2px rgba(211,84,0,0.2); }
        .setting-card { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); padding: 18px; border-radius: 20px; box-shadow: 0 8px 25px rgba(0,0,0,0.03); margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.6); }
        .btn { background: #2d3436; color: white; border: none; padding: 10px 18px; border-radius: 15px; font-size: 14px; font-weight: bold; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn:active { transform: scale(0.95); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn.danger { background: #ff7675; color: white; }

        /* ğŸ“š ä¿®å¤ä¹¦æ¶å°ºå¯¸ï¼šå®Œå®Œå…¨å…¨é€€å› V32 çš„ç²¾è‡´å°å·§æ¯”ä¾‹ */
        #shelf-list { padding: 15px 20px 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; padding-bottom: 150px; }
        .book-cover { aspect-ratio: 2/3; border-radius: 8px; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; text-align: center; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.2s; }
        .book-cover:active { transform: scale(0.95); }

        /* é˜…è¯»å™¨è½¯åŒ– */
        #reader-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; padding-bottom: 0; }
        #reader-overlay.active { display: flex; }
        #reader-header { height: 60px; background: rgba(248,245,230,0.85); backdrop-filter: blur(15px); border-bottom: none; box-shadow: 0 4px 20px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; border-radius: 0 0 25px 25px; margin-bottom: 5px; z-index: 10; padding-top: env(safe-area-inset-top); }
        #reader-content { flex: 1; overflow-y: auto; padding: 20px 20px 120px; font-size: 19px; line-height: 1.8; text-align: justify; user-select: text; -webkit-user-select: text; }

        /* ä¾§è¾¹æ è½¯åŒ– */
        #toc-sidebar { position: fixed; top: 0; left: 0; width: 75%; max-width: 320px; height: 100%; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px); z-index: 4500; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); transform: translateX(-100%); display: flex; flex-direction: column; border-radius: 0 25px 25px 0; box-shadow: 10px 0 40px rgba(0,0,0,0.08); }
        #toc-sidebar.active { transform: translateX(0); }
        .toc-item { padding: 16px 20px; border-bottom: 1px solid rgba(0,0,0,0.03); font-size: 15px; color: #444; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background 0.2s; }
        .toc-item:active { background: #f8f8f8; }

        #sidebar { position: fixed; top: 0; right: 0; width: 100%; height: 100%; max-width: 450px; background: #fcfcfc; z-index: 4000; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); transform: translateX(100%); display: flex; flex-direction: column; border-radius: 25px 0 0 25px; box-shadow: -10px 0 40px rgba(0,0,0,0.1); }
        #sidebar.active { transform: translateX(0); }
        
        .msg-container { margin-bottom: 18px; display: flex; flex-direction: column; width: 100%; }
        .msg-bubble { max-width: 85%; padding: 14px 16px; border-radius: 20px; font-size: 15px; line-height: 1.6; position: relative; word-wrap: break-word; box-shadow: 0 4px 15px rgba(0,0,0,0.04); }
        .msg-container.ai { align-items: flex-start; }
        .msg-container.ai .msg-bubble { background: var(--ai-bubble); border-bottom-left-radius: 6px; }
        .msg-container.user { align-items: flex-end; }
        .msg-container.user .msg-bubble { background: var(--user-bubble); color: white; border-bottom-right-radius: 6px; }
        
        .msg-actions { display: flex; gap: 15px; margin-top: 8px; padding: 0 8px; font-size: 12px; color: #a4b0be; }
        .action-link { cursor: pointer; display: flex; align-items: center; gap: 4px; transition: color 0.2s; }
        .action-link:hover { color: var(--accent); }
        .action-link.danger { color: #ff7675; }

        #floating-dock { position: fixed; right: -250px; top: 40%; background: rgba(45,52,54,0.85); backdrop-filter: blur(10px); color: white; border-radius: 25px 0 0 25px; padding: 5px; z-index: 3000; transition: right 0.2s cubic-bezier(0.25, 1, 0.5, 1); display: flex; flex-direction: column; gap: 1px; border-left: 4px solid var(--accent); box-shadow: -5px 10px 30px rgba(0,0,0,0.15); }
        #floating-dock.visible { right: 0; }
        .dock-btn { padding: 14px 22px; font-weight: bold; font-size: 15px; white-space: nowrap; cursor: pointer; user-select: none; transition: background 0.2s; border-radius: 20px; }
        .dock-btn:active { background: rgba(255,255,255,0.1); }

        mark.ai-mark { background: var(--mark-bg); color: inherit; cursor: pointer; border-bottom: 2px solid #e67e22; padding-bottom: 0; margin: 0; border-radius: 4px; padding: 0 2px; }
        .ai-anchor { display: inline-flex; width: 22px; height: 22px; background: var(--accent); color: white; border-radius: 50%; font-size: 10px; justify-content: center; align-items: center; margin-right: 4px; vertical-align: middle; cursor: pointer; box-shadow: 0 2px 5px rgba(211,84,0,0.3); }
        
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); backdrop-filter: blur(5px); color: white; padding: 16px 30px; border-radius: 30px; font-size: 15px; z-index: 9999; display: none; text-align:center; max-width: 80%; pointer-events: none; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 5000; justify-content: center; align-items: flex-end; }
        .modal-box { background: var(--bg); width: 100%; height: 90vh; border-radius: 30px 30px 0 0; display:flex; flex-direction:column; animation: slideUp 0.3s cubic-bezier(0.25, 1, 0.5, 1); padding-bottom: var(--safe-bottom); box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .tl-book-group { background: rgba(255,255,255,0.7); backdrop-filter: blur(10px); border-radius: 18px; margin-bottom: 20px; box-shadow: 0 6px 20px rgba(0,0,0,0.03); overflow: hidden; border: 1px solid rgba(255,255,255,0.8); }
        .tl-header { padding: 18px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; transition: background 0.2s; }
        .tl-title { font-weight: bold; font-size: 16px; color: #333; display: flex; align-items: center; gap: 8px; }
        .tl-arrow { transition: transform 0.3s ease; color: #a4b0be; font-size: 12px; }
        .tl-book-group.collapsed .tl-notes-container { display: none; }
        .tl-book-group.collapsed .tl-arrow { transform: rotate(-90deg); }
        .tl-note-item { padding: 18px; border-top: 1px solid rgba(0,0,0,0.03); transition: background 0.2s; position: relative; }

        #action-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: #f9f9f9; z-index: 6000; border-radius: 30px 30px 0 0; box-shadow: 0 -5px 30px rgba(0,0,0,0.15); transform: translateY(100%); transition: transform 0.2s cubic-bezier(0.25, 1, 0.5, 1); padding-bottom: max(20px, var(--safe-bottom)); }
        #action-sheet.active { transform: translateY(0); }
        .as-btn { display: block; width: 100%; padding: 20px; text-align: center; font-size: 16px; border: none; background: white; color: #333; margin-bottom: 2px; }
        .as-btn.danger { color: #ff7675; font-weight: bold; }
        #as-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.3); z-index: 5999; display: none; opacity: 0; transition: opacity 0.2s; backdrop-filter: blur(3px); }
        #as-mask.active { display: block; opacity: 1; }
    </style>
</head>
<body>

<div id="toast"></div>

<!-- Action Sheet -->
<div id="as-mask" onclick="closeActionSheet()"></div>
<div id="action-sheet">
    <div style="padding:15px; text-align:center; color:#999; font-size:12px; background:white; border-radius:30px 30px 0 0">é€‰æ‹©æ“ä½œ</div>
    <button class="as-btn danger" id="as-del-btn">ğŸ—‘ï¸ åˆ é™¤è¿™æ¡ç¬”è®°</button>
    <div style="height:8px;background:#f9f9f9"></div>
    <button class="as-btn" style="border-radius:0" onclick="closeActionSheet()">å–æ¶ˆ</button>
</div>

<!-- Loader -->
<div id="loader" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,0.85);backdrop-filter:blur(8px);z-index:6000;justify-content:center;align-items:center;flex-direction:column">
    <div style="font-size:35px;animation:spin 1s linear infinite">ğŸ§ </div>
    <div style="margin:20px;color:#d35400;font-weight:bold" id="loader-text">AI æ­£åœ¨æ€è€ƒ...</div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
</div>

<!-- ğŸ“± æ‚¬æµ®å¯¼èˆªæ  -->
<div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('shelf')">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
        </svg>
        <div style="margin-top:2px">ä¹¦æ¶</div>
    </div>
    <div class="tab-item" onclick="switchTab('timeline')">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
        </svg>
        <div style="margin-top:2px">å½’æ¡£</div>
    </div>
    <!-- ğŸ‘¤ äººè®¾ï¼šæ¢æˆäº†é«˜çº§æç®€å°äººå›¾æ ‡ -->
    <div class="tab-item" onclick="switchTab('persona')">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
        </svg>
        <div style="margin-top:2px">äººè®¾</div>
    </div>
    <div class="tab-item" onclick="switchTab('settings')">
        <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
        </svg>
        <div style="margin-top:2px">é…ç½®</div>
    </div>
</div>

<!-- Main Views -->
<div id="main-view">
    <!-- ğŸ“š ä¹¦æ¶ -->
    <div id="view-shelf" class="view-page active">
        <div style="padding:15px 20px 5px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold;font-size:1.4rem;color:var(--text)">æˆ‘çš„è—ä¹¦</span>
            <button class="btn" style="background:rgba(255,255,255,0.7);backdrop-filter:blur(10px);color:var(--text);box-shadow:none" onclick="document.getElementById('file-in').click()">â• å¯¼å…¥æ–‡ä»¶</button>
            <input type="file" id="file-in" hidden accept=".txt,.pdf,.epub">
        </div>
        <div id="shelf-list"></div>
        <div id="empty-tip" style="margin:20px;background:rgba(255,255,255,0.6);backdrop-filter:blur(10px);padding:40px;border-radius:20px;text-align:center;color:#888;display:none;line-height:1.8">
            <div style="font-size:30px;margin-bottom:10px">â˜ï¸</div>
            ä¹¦æ¶ç©ºç©ºçš„å“¦~<br>ç‚¹å³ä¸Šè§’å¯¼å…¥ä½ çš„ç¬¬ä¸€æœ¬ä¹¦å§ï¼
        </div>
    </div>
    
    <!-- ğŸ“‚ å½’æ¡£ -->
    <div id="view-timeline" class="view-page">
        <div style="padding:15px 20px;background:rgba(255,255,255,0.6);backdrop-filter:blur(15px);position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;border-radius:0 0 25px 25px">
            <select id="timeline-filter" onchange="refreshTimeline()" style="margin:0;border:none;background:transparent;font-weight:bold;color:var(--text);font-size:16px;padding:0;box-shadow:none;width:auto">
                <option value="all">ğŸ“‚ å…¨éƒ¨ç¬”è®°å½’æ¡£</option>
            </select>
            <span style="font-size:12px;color:#a4b0be">é•¿æŒ‰ç®¡ç†</span>
        </div>
        <div id="timeline-content" style="padding:20px"></div>
    </div>

    <!-- ğŸ­ äººè®¾ -->
    <div id="view-persona" class="view-page">
        <div style="padding:20px 20px 100px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                <span style="font-weight:bold;font-size:1.4rem;color:var(--text)">AI äººè®¾åº“</span>
                <button class="btn" style="background:rgba(255,255,255,0.7);color:var(--text);box-shadow:none" onclick="addNewPersona()">â• æ–°å¢äººè®¾</button>
            </div>
            <div id="persona-list-container" style="display:flex;flex-direction:column;gap:15px;"></div>
        </div>
    </div>

    <!-- âš™ï¸ è®¾ç½® -->
    <div id="view-settings" class="view-page">
        <div style="padding:20px 20px 100px;">
            <span style="font-weight:bold;font-size:1.4rem;color:var(--text);display:block;margin-bottom:20px">ç³»ç»Ÿé…ç½®</span>
            
            <div class="setting-card">
                <label style="font-weight:bold;display:block;margin-bottom:10px;color:#2c3e50">ğŸ“¡ API é¢„è®¾æ–¹æ¡ˆ</label>
                <div style="display:flex;gap:10px;margin-bottom:15px">
                    <select id="preset-select" onchange="switchPreset()" style="margin:0;flex:1"></select>
                    <button class="btn" style="background:#e67e22" onclick="savePresetAsNew()">ğŸ’¾ å¦å­˜</button>
                    <button class="btn danger" style="padding:10px 15px" onclick="deleteCurrentPreset()">ğŸ—‘ï¸</button>
                </div>
                <div style="background:rgba(255,255,255,0.5);padding:15px;border-radius:15px">
                    <label style="font-size:13px;color:#666">API Key</label>
                    <input type="password" id="api-key" onchange="updateCurrentPreset()" placeholder="sk-...">
                    <label style="font-size:13px;color:#666;display:block;margin-top:10px">API URL</label>
                    <input type="text" id="api-url" onchange="updateCurrentPreset()" placeholder="https://api.openai.com/v1">
                    <label style="font-size:13px;color:#666;display:block;margin-top:10px">æ¨¡å‹åç§° (å¯æ‰‹åŠ¨è¾“å…¥æˆ–åˆ·æ–°)</label>
                    <div style="display:flex;gap:10px;align-items:center">
                        <datalist id="model-list"></datalist>
                        <input type="text" id="api-model" list="model-list" onchange="updateCurrentPreset()" style="margin:0;flex:1" placeholder="ä¾‹å¦‚: gpt-3.5-turbo">
                        <button class="btn" onclick="fetchModelsForPreset()" style="background:#a4b0be;margin-top:5px">ğŸ”„ åˆ·æ–°</button>
                    </div>
                </div>
            </div>

            <div class="setting-card">
                <label style="font-weight:bold;display:block;margin-bottom:5px;color:var(--text)">ğŸ“„ å¯¼å…¥ä¹±ç ä¿®å¤</label>
                <div style="font-size:12px;color:#888;margin-bottom:10px">å¦‚æœå¯¼å…¥çš„TXTæ˜¯ä¹±ç ï¼Œè¯·åˆ‡æ¢ä¸º GBK åé‡æ–°å¯¼å…¥</div>
                <select id="encoding-select" onchange="GS.encoding = this.value" style="margin:0">
                    <option value="utf-8">UTF-8 (é»˜è®¤/ç°ä»£æ–‡ä»¶)</option>
                    <option value="gbk">GBK (ä¸­æ–‡/è€æ—§æ–‡ä»¶)</option>
                </select>
            </div>
            
            <div class="setting-card">
                <label style="font-weight:bold;color:var(--text)">ğŸ’¾ æ—§æ•°æ®æ‰¾å›</label>
                <div style="font-size:12px;color:#888;margin-bottom:10px;line-height:1.5">
                    ä¹¦ä¸è§äº†ï¼Ÿå¯èƒ½åœ¨æ—§ä»“åº“é‡Œã€‚<br>è¯•è¯•è¾“å…¥ï¼š<b>SoulReaderV20</b> æ‰¾å›æ—§ç‰ˆæ•°æ®ã€‚
                </div>
                <div style="display:flex;gap:10px">
                    <input type="text" id="db-name-input" placeholder="è¾“å…¥ä»“åº“å..." style="margin:0">
                    <button class="btn" style="background:#34495e" onclick="switchDB()">åŠ è½½</button>
                </div>
                <div style="font-size:12px;color:#d35400;margin-top:10px;font-weight:bold">å½“å‰ä½¿ç”¨ä»“åº“: <span id="current-db-display"></span></div>
            </div>
        </div>
    </div>
</div>

<!-- Reader -->
<div id="reader-overlay">
    <div id="reader-header">
        <button class="btn" style="background:transparent;color:#333;font-size:22px;padding:0;width:30px;box-shadow:none" onclick="closeReader()">â¬…</button>
        <button class="btn" style="background:transparent;color:#888;font-size:22px;padding:0;width:40px;box-shadow:none" onclick="document.getElementById('toc-sidebar').classList.add('active')">ğŸ“‘</button>
        <span id="book-title-header" style="font-weight:bold;flex:1;text-align:center;margin:0 10px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis"></span>
        <button class="btn" style="background:rgba(255,255,255,0.8);color:#555;padding:6px 14px;font-size:13px;box-shadow:none;border-radius:12px" onclick="openBookConfig()">ğŸ§  è®°å¿†</button>
    </div>
    
    <div id="toc-sidebar">
        <div style="padding:18px 20px;background:rgba(248,245,230,0.5);display:flex;justify-content:space-between;align-items:center;height:60px;">
            <span style="font-weight:bold;color:#444;font-size:16px">ğŸ“‘ æ™ºèƒ½ç›®å½•</span>
            <button onclick="document.getElementById('toc-sidebar').classList.remove('active')" style="border:none;background:none;font-size:26px;color:#a4b0be;cursor:pointer;">Ã—</button>
        </div>
        <div id="toc-list" style="flex:1;overflow-y:auto;background:transparent;padding-bottom:var(--safe-bottom);"></div>
    </div>

    <div id="reader-content" onscroll="handleScroll()"></div>
    <div id="floating-dock">
        <div class="dock-btn" id="btn-ai">âš¡ AI åæ§½</div>
        <div style="height:1px;background:rgba(255,255,255,0.1);margin:0 15px"></div>
        <div class="dock-btn" id="btn-user">âœï¸ è‡ªå·±å†™</div>
    </div>
</div>

<!-- Sidebar -->
<div id="sidebar">
    <div style="padding:15px 20px;background:white;display:flex;justify-content:space-between;align-items:center;height:65px;border-radius:25px 0 0 0">
        <span style="font-weight:bold;font-size:16px;color:var(--text)">ğŸ“ æ‰¹æ³¨è¯¦æƒ…</span>
        <div style="display:flex;gap:12px;align-items:center">
            <button class="btn" style="background:#f0f0f0;color:#444;padding:6px 12px;font-size:12px;box-shadow:none" onclick="summarizeThread()">âœ¨ å­˜å…¥è®°å¿†</button>
            <button onclick="document.getElementById('sidebar').classList.remove('active')" style="border:none;background:none;font-size:26px;color:#a4b0be;padding:0">Ã—</button>
        </div>
    </div>
    
    <div id="chat-quote-container" style="padding:18px 20px;background:#fdfdfd;box-shadow:inset 0 -2px 10px rgba(0,0,0,0.01);">
        <div style="font-size:12px;color:#a4b0be;margin-bottom:8px">åŸæ–‡æ‘˜å½•ï¼š</div>
        <div id="chat-quote" style="font-style:italic;color:#555;font-size:15px;line-height:1.5;max-height:85px;overflow-y:auto;border-left:4px solid #ddd;padding-left:10px"></div>
    </div>

    <div id="chat-list" style="flex:1;overflow-y:auto;padding:20px;background:transparent"></div>

    <div style="padding:15px;background:rgba(255,255,255,0.8);backdrop-filter:blur(10px);display:flex;flex-direction:column;gap:10px;padding-bottom:calc(15px + var(--safe-bottom))">
        <textarea id="chat-input" rows="1" placeholder="è·Ÿå½“å‰äººè®¾èŠèŠè¿™æ®µè¯..." style="margin:0;min-height:45px;resize:none;background:#f5f6fa;border-radius:20px"></textarea>
        <div style="display:flex;justify-content:flex-end;gap:10px">
            <button class="btn" style="background:#a4b0be;padding:8px 18px;border-radius:20px;box-shadow:none" onclick="sendMsg(false)">ä»…è®°å½•</button>
            <button class="btn" style="background:var(--text);padding:8px 20px;border-radius:20px" onclick="sendMsg(true)">âœ¨ å‘é€ç»™AI</button>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="book-config-modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-box">
        <div style="padding:20px;display:flex;justify-content:space-between;align-items:center;background:transparent;border-radius:30px 30px 0 0">
            <span style="font-weight:bold;font-size:16px;color:var(--text)">ğŸ“˜ æœ¬ä¹¦å¤§è„‘ (Memory)</span>
            <span onclick="document.getElementById('book-config-modal').style.display='none'" style="cursor:pointer;font-size:26px;color:#a4b0be">Ã—</span>
        </div>
        <div style="flex:1;overflow-y:auto;padding:20px;">
            <div class="setting-card">
                 <label style="font-size:14px;font-weight:bold;display:block;margin-bottom:10px;color:#2c3e50">ğŸ“š ä¹¦ç±èƒŒæ™¯ / æ‘˜è¦</label>
                 <textarea id="current-book-context" rows="3" placeholder="è¿™æœ¬ä¹¦è®²äº†ä»€ä¹ˆ..." onchange="saveBookConfig()" style="background:rgba(255,255,255,0.5)"></textarea>
                 <button class="btn" style="width:100%;margin-top:12px;background:rgba(255,255,255,0.8);color:#444;box-shadow:none" onclick="autoAnalyze()">âœ¨ AI è‡ªåŠ¨æå–å…¨ä¹¦èƒŒæ™¯</button>
            </div>
            <div style="font-size:14px;font-weight:bold;margin-bottom:15px;color:#2c3e50;padding-left:5px">ğŸ§  é•¿æœŸè®°å¿†å¡ç‰‡ (ä¸AIäº¤æµæ—¶ç”Ÿæ•ˆ)</div>
            <div id="memory-list"></div>
            <button class="btn" style="width:100%;margin-top:10px;background:rgba(255,255,255,0.5);color:#888;box-shadow:none" onclick="addEmptyMemory()">+ æ‰‹åŠ¨æ·»åŠ ä¸€æ¡è®°å¿†</button>
        </div>
    </div>
</div>

<script>
    // --- Data & Config Initialization ---
    let DB_NAME = localStorage.getItem('sr_dbname') || 'SoulReaderV20';
    let db, currentBook = null, activeNoteId = null;

    // ğŸ“¡ API Presets Logic
    let apiPresets = JSON.parse(localStorage.getItem('sr_api_presets')) ||[
        { name: "é»˜è®¤é…ç½®", url: "https://api.openai.com/v1", key: "", model: "gpt-3.5-turbo" }
    ];
    let activePresetIdx = parseInt(localStorage.getItem('sr_active_preset_idx')) || 0;
    if(!apiPresets[activePresetIdx]) activePresetIdx = 0;

    // ğŸ­ Personas Logic
    let personas = JSON.parse(localStorage.getItem('sr_personas')) ||[
        { name: "é»˜è®¤äººè®¾", content: "ä½ æ˜¯ä¸€ä¸ªå®¢è§‚ã€ç†æ€§çš„è¯»ä¹¦åŠ©æ‰‹ã€‚" }
    ];
    let activePersonaIdx = parseInt(localStorage.getItem('sr_active_persona_idx')) || 0;
    if(!personas[activePersonaIdx]) activePersonaIdx = 0;

    // å…¨å±€ GS å¯¹è±¡
    const GS = {
        get url() { return apiPresets[activePresetIdx].url || 'https://api.openai.com/v1'; },
        get key() { return apiPresets[activePresetIdx].key || ''; },
        get model() { return apiPresets[activePresetIdx].model || 'gpt-3.5-turbo'; },
        get persona() { return personas[activePersonaIdx].content || ''; },
        get encoding() { return localStorage.getItem('sr_encoding')||'utf-8'; },
        set encoding(v) { localStorage.setItem('sr_encoding', v); }
    };

    renderPresetUI(); renderPersonas();
    document.getElementById('encoding-select').value = GS.encoding;
    document.getElementById('db-name-input').value = DB_NAME;
    document.getElementById('current-db-display').innerText = DB_NAME;

    function updateCurrentPreset() { apiPresets[activePresetIdx].key = document.getElementById('api-key').value.trim(); apiPresets[activePresetIdx].url = document.getElementById('api-url').value.trim(); apiPresets[activePresetIdx].model = document.getElementById('api-model').value.trim(); saveConfigData(); }
    function switchPreset() { activePresetIdx = document.getElementById('preset-select').selectedIndex; saveConfigData(); renderPresetUI(); }
    function savePresetAsNew() { const name = prompt("ç»™å½“å‰ API é…ç½®æ–¹æ¡ˆèµ·ä¸ªåå­—ï¼š", "æ–°æ–¹æ¡ˆ"); if(!name) return; apiPresets.push({ name: name, url: document.getElementById('api-url').value.trim(), key: document.getElementById('api-key').value.trim(), model: document.getElementById('api-model').value.trim() }); activePresetIdx = apiPresets.length - 1; saveConfigData(); renderPresetUI(); showToast("âœ… æ–° API æ–¹æ¡ˆå·²ä¿å­˜"); }
    function deleteCurrentPreset() { if(apiPresets.length <= 1) return showToast("âš ï¸ è‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ª API æ–¹æ¡ˆ"); if(confirm(`ç¡®å®šåˆ é™¤æ–¹æ¡ˆã€${apiPresets[activePresetIdx].name}ã€‘å—ï¼Ÿ`)) { apiPresets.splice(activePresetIdx, 1); activePresetIdx = 0; saveConfigData(); renderPresetUI(); } }
    function renderPresetUI() { const sel = document.getElementById('preset-select'); sel.innerHTML = ''; apiPresets.forEach((p, i) => sel.add(new Option(p.name, i))); sel.selectedIndex = activePresetIdx; document.getElementById('api-key').value = apiPresets[activePresetIdx].key; document.getElementById('api-url').value = apiPresets[activePresetIdx].url; document.getElementById('api-model').value = apiPresets[activePresetIdx].model; }
    async function fetchModelsForPreset() { showToast("æ­£åœ¨è·å–æ¨¡å‹åˆ—è¡¨..."); try { const r = await fetch(`${GS.url}/models`, {headers: {'Authorization': `Bearer ${GS.key}`}}); const d = await r.json(); const dl = document.getElementById('model-list'); dl.innerHTML = ''; (d.data || d).forEach(m => { const opt = document.createElement('option'); opt.value = m.id; dl.appendChild(opt); }); showToast("âœ… åˆ·æ–°æˆåŠŸï¼Œè¯·ç‚¹å‡»ä¸‹æ‹‰é€‰æ‹©"); } catch(e) { alert(e.message); } }

    function renderPersonas() {
        const c = document.getElementById('persona-list-container'); c.innerHTML = '';
        personas.forEach((p, idx) => {
            const isActive = idx === activePersonaIdx;
            const div = document.createElement('div'); div.className = 'setting-card'; div.style.padding = '20px'; div.style.border = isActive ? '2px solid rgba(0,0,0,0.1)' : '1px solid transparent'; div.style.background = isActive ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.6)';
            div.innerHTML = `
                <div style="font-weight:bold;font-size:16px;color:var(--text);margin-bottom:10px;">${p.name} ${isActive?'<span style="font-size:11px;background:#f0f0f0;color:#555;padding:3px 8px;border-radius:12px;margin-left:8px;vertical-align:middle">å½“å‰ç”Ÿæ•ˆä¸­</span>':''}</div>
                <div style="font-size:14px;color:#666;line-height:1.6;margin-bottom:15px;display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden">${p.content}</div>
                <div style="display:flex;gap:10px;">
                    ${!isActive ? `<button class="btn" style="flex:1;background:rgba(255,255,255,0.8);color:#333;box-shadow:none;border:1px solid #ddd" onclick="usePersona(${idx})">âœ… è®¾ä¸ºå½“å‰</button>` : ''}
                    <button class="btn" style="background:rgba(0,0,0,0.05);color:#555;padding:10px 15px;box-shadow:none" onclick="editPersona(${idx})">âœï¸</button>
                    <button class="btn danger" style="padding:10px 15px;box-shadow:none" onclick="deletePersona(${idx})">ğŸ—‘ï¸</button>
                </div>
            `;
            c.appendChild(div);
        });
    }
    function usePersona(idx) { activePersonaIdx = idx; saveConfigData(); renderPersonas(); showToast("âœ… AI äººè®¾å·²åˆ‡æ¢"); }
    function addNewPersona() { const name = prompt("ç»™æ–°äººè®¾èµ·ä¸ªåå­—ï¼ˆå¦‚ï¼šä¸­äºŒå°‘å¹´ï¼‰ï¼š"); if(!name) return; personas.push({ name: name, content: "è¯·åœ¨æ­¤å¤„å¡«å†™å…·ä½“çš„è®¾å®šæç¤ºè¯..." }); activePersonaIdx = personas.length - 1; saveConfigData(); renderPersonas(); editPersona(activePersonaIdx); }
    function editPersona(idx) { const p = personas[idx]; const newContent = prompt(`æ­£åœ¨ç¼–è¾‘ã€${p.name}ã€‘çš„è®¾å®šï¼š\n(å¦‚éœ€æ¢è¡Œè¯·å°½é‡ç²¾ç®€)`, p.content); if(newContent !== null && newContent.trim() !== '') { p.content = newContent; saveConfigData(); renderPersonas(); } }
    function deletePersona(idx) { if(personas.length <= 1) return showToast("âš ï¸ ç³»ç»Ÿè‡³å°‘éœ€è¦ä¿ç•™ä¸€ä¸ªäººè®¾åº•åº§å“¦ï¼"); if(confirm(`ç¡®å®šè¦åˆ é™¤äººè®¾ã€${personas[idx].name}ã€‘å—ï¼Ÿ`)) { personas.splice(idx, 1); if(activePersonaIdx >= personas.length) activePersonaIdx = personas.length - 1; saveConfigData(); renderPersonas(); } }
    function saveConfigData() { localStorage.setItem('sr_api_presets', JSON.stringify(apiPresets)); localStorage.setItem('sr_active_preset_idx', activePresetIdx); localStorage.setItem('sr_personas', JSON.stringify(personas)); localStorage.setItem('sr_active_persona_idx', activePersonaIdx); }

    window.openSidebarById = async function(id) { const n=await Store.get('notes',id); if(n) openSidebar(n); };
    function switchDB() { const newName = document.getElementById('db-name-input').value.trim(); if(!newName || newName === DB_NAME) return; if(confirm(`åˆ‡æ¢åˆ°ä»“åº“ "${newName}" å—ï¼Ÿé¡µé¢å°†åˆ·æ–°ã€‚`)) { localStorage.setItem('sr_dbname', newName); location.reload(); } }
    function initDB(){return new Promise(r=>{ const q=indexedDB.open(DB_NAME,2); q.onupgradeneeded=e=>{db=e.target.result; if(!db.objectStoreNames.contains('books'))db.createObjectStore('books',{keyPath:'id'}); if(!db.objectStoreNames.contains('notes')){const n=db.createObjectStore('notes',{keyPath:'id'});n.createIndex('bookId','bookId',{unique:false})}}; q.onsuccess=e=>{db=e.target.result;r();refreshShelf();refreshTimeline();}; })}
    const Store={put:(t,d)=>new Promise(r=>{const x=db.transaction(t,'readwrite');x.objectStore(t).put(d);x.oncomplete=r}),getAll:t=>new Promise(r=>{const x=db.transaction(t,'readonly');x.objectStore(t).getAll().onsuccess=e=>r(e.target.result)}),get:(t,id)=>new Promise(r=>{const x=db.transaction(t,'readonly');x.objectStore(t).get(id).onsuccess=e=>r(e.target.result)}),del:(t,id)=>new Promise(r=>{const x=db.transaction(t,'readwrite');x.objectStore(t).delete(id);x.oncomplete=r})};

    async function refreshShelf(){
        const bs=await Store.getAll('books'); const l=document.getElementById('shelf-list'); l.innerHTML='';
        document.getElementById('empty-tip').style.display = bs.length ? 'none' : 'block';
        const filter = document.getElementById('timeline-filter'); const currentVal = filter.value; filter.innerHTML = '<option value="all">ğŸ“‚ å…¨éƒ¨ç¬”è®°å½’æ¡£</option>';
        bs.forEach(b => {
            const op = document.createElement('option'); op.value = b.id; op.innerText = `ğŸ“– ${b.title}`; filter.appendChild(op);
            const d=document.createElement('div');d.className='book-cover';d.style.background=b.color;
            d.innerHTML=`<div style="font-weight:bold;font-size:13px;overflow:hidden;max-height:45px;line-height:1.2;text-shadow:0 1px 2px rgba(0,0,0,0.2)">${b.title}</div><div style="font-size:10px;margin-top:6px;opacity:0.9;background:rgba(0,0,0,0.15);padding:2px 8px;border-radius:10px">${b.type.toUpperCase()}</div><div onclick="delBook(event,'${b.id}')" style="position:absolute;top:-6px;right:-6px;background:rgba(255,255,255,0.9);color:#ff7675;width:22px;height:22px;border-radius:50%;line-height:20px;cursor:pointer;font-weight:bold;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,0.1)">Ã—</div>`;
            d.onclick=e=>{if(!e.target.innerText.includes('Ã—'))openReader(b)}; l.appendChild(d);
        });
        if(currentVal && Array.from(filter.options).some(o=>o.value==currentVal)) filter.value = currentVal;
    }
    
    async function openReader(b){
        currentBook=b; if(!currentBook.memories) currentBook.memories=[]; document.getElementById('reader-overlay').classList.add('active'); document.getElementById('book-title-header').innerText=b.title;
        let tempContent = b.content; let tocHTML = ''; let chapIdx = 0; const chapRegex = /<p>\s*(ç¬¬[\u4e00-\u9fa50-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚å·éƒ¨].{0,30}|Chapter\s*\d+.*?|å¼•å­|ç•ªå¤–.*?|å‰è¨€|åºè¨€|å°¾å£°|åè®°)<\/p>/g;
        tempContent = tempContent.replace(chapRegex, (match, title) => { chapIdx++; const curId = `toc-chap-${chapIdx}`; tocHTML += `<div class="toc-item" onclick="jumpToChap('${curId}')">${title}</div>`; return `<p id="${curId}" style="font-weight:bold;color:#444;font-size:1.3em;margin-top:1.5em;padding-bottom:10px;border-bottom:2px dashed rgba(0,0,0,0.05);">${title}</p>`; });
        if(chapIdx === 0) tocHTML = '<div style="padding:40px 20px;text-align:center;color:#a4b0be;font-size:14px;line-height:1.6">ğŸ¤– æ™ºèƒ½æå–æœªå‘ç°ç« èŠ‚ã€‚<br><br>æœ¬ä¹¦å¯èƒ½æ˜¯çŸ­ç¯‡ã€æœªåˆ†ç« ï¼Œæˆ–æ˜¯æ’ç‰ˆç‰¹æ®Šã€‚</div>';
        document.getElementById('toc-list').innerHTML = tocHTML; document.getElementById('reader-content').innerHTML = tempContent; setTimeout(()=>document.getElementById('reader-content').scrollTop=b.scroll,100);
        const ns=await Store.getAll('notes'); restoreHighlights(ns.filter(n=>n.bookId===b.id));
    }
    window.jumpToChap = function(id) { const el = document.getElementById(id); if(el) { document.getElementById('reader-content').scrollTo({ top: el.offsetTop - 70, behavior: 'smooth' }); document.getElementById('toc-sidebar').classList.remove('active'); } }
    function closeReader(){document.getElementById('reader-overlay').classList.remove('active');refreshShelf();refreshTimeline()}

    function restoreHighlights(notes) {
        if(!notes || !notes.length) return; const root = document.getElementById('reader-content'); const content = root.innerHTML; const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false); const textNodes =[]; let node; while(node = walker.nextNode()) textNodes.push(node);
        notes.forEach(note => { if(content.includes(`window.openSidebarById('${note.id}')`)) return; for(let tn of textNodes) { const idx = tn.nodeValue.indexOf(note.quote); if(idx !== -1) { try { const range = document.createRange(); range.setStart(tn, idx); range.setEnd(tn, idx + note.quote.length); const wrapper = document.createElement('mark'); wrapper.className = 'ai-mark'; wrapper.dataset.nid = note.id; wrapper.textContent = note.quote; wrapper.onclick = (e) => { e.stopPropagation(); window.openSidebarById(note.id); }; range.deleteContents(); range.insertNode(wrapper); break; } catch(e) {} } } });
    }

    document.addEventListener('selectionchange', () => { const s = window.getSelection(); const d = document.getElementById('floating-dock'); if(!s.isCollapsed && document.getElementById('reader-content').contains(s.anchorNode)) d.classList.add('visible'); else setTimeout(()=> { if(window.getSelection().isCollapsed) d.classList.remove('visible') }, 300); });
    const handleCreate = (e, mode) => { e.preventDefault(); e.stopPropagation(); const s = window.getSelection(); if(s.isCollapsed) return showToast("âš ï¸ è¯·å…ˆé€‰ä¸­ä¸€æ®µæ–‡å­—"); const range = s.getRangeAt(0).cloneRange(); const text = s.toString(); if(!text.trim()) return showToast("âš ï¸ é€‰åŒºå†…å®¹ä¸ºç©º"); createNoteWithSelection(range, text, mode); };
    ['mousedown','touchstart'].forEach(evt => { document.getElementById('btn-ai').addEventListener(evt, e => handleCreate(e, 'ai')); document.getElementById('btn-user').addEventListener(evt, e => handleCreate(e, 'user')); });

    async function createNoteWithSelection(range, text, mode) {
        const allNotes = await Store.getAll('notes'); if(allNotes.find(n => n.bookId === currentBook.id && n.quote === text) && !confirm("âš ï¸ è¿™æ®µè¯å·²ç»æ ‡è®°è¿‡å•¦ï¼Œè¿˜è¦é‡å¤æ ‡è®°å—ï¼Ÿ")) { window.getSelection().removeAllRanges(); document.getElementById('floating-dock').classList.remove('visible'); return; }
        document.getElementById('floating-dock').classList.remove('visible'); const nid = 'n'+Date.now();
        try { const wrapper = document.createElement('mark'); wrapper.className = 'ai-mark'; wrapper.dataset.nid = nid; wrapper.innerText = text; wrapper.onclick = (e) => { e.stopPropagation(); window.openSidebarById(nid); }; range.deleteContents(); range.insertNode(wrapper); } 
        catch(e) { const anchor = document.createElement('span'); anchor.className = 'ai-anchor'; anchor.innerText = 'ğŸ“'; anchor.dataset.nid = nid; anchor.onclick = (e) => { e.stopPropagation(); window.openSidebarById(nid); }; range.collapse(true); range.insertNode(anchor); }
        window.getSelection().removeAllRanges(); const note = { id:nid, bookId:currentBook.id, quote:text, time:Date.now(), messages:[], contextPre: "...", contextPost: "..." }; await Store.put('notes', note); if(mode=='ai') triggerAI(note); else openSidebar(note);
    }

    function openSidebar(n){activeNoteId=n.id;document.getElementById('sidebar').classList.add('active');document.getElementById('chat-quote').innerText=n.quote;renderChat(n.messages)}
    function renderChat(ms){
        const l=document.getElementById('chat-list'); l.innerHTML=''; if(ms.length==0) l.innerHTML='<div style="text-align:center;color:#a4b0be;margin-top:40px;font-size:14px">âœ¨ å¯¹è¯ç©ºç©ºå¦‚ä¹Ÿï¼Œå¿«è·ŸAIèŠèŠå§</div>';
        ms.forEach((m, idx)=>{
            const isAI = m.role=='ai'; const actionsHTML = `<div class="msg-actions">${!isAI ? `<span class="action-link" onclick="editMsg(${idx})">âœï¸ ç¼–è¾‘</span>` : ''} ${isAI && idx===ms.length-1 ? `<span class="action-link" onclick="retryAI()">ğŸ”„ é‡å†™</span>` : ''} <span class="action-link danger" onclick="deleteMsg(${idx})">ğŸ—‘ï¸ åˆ é™¤</span> <span class="action-link" onclick="safeCopy('${m.content.replace(/'/g,"\\'").replace(/\n/g," ")}')">ğŸ“„ å¤åˆ¶</span></div>`;
            const d=document.createElement('div'); d.className=`msg-container ${m.role}`; d.innerHTML = `<div class="msg-bubble">${formatText(m.content)}</div>${actionsHTML}`; l.appendChild(d);
        }); l.scrollTop=l.scrollHeight;
    }

    async function refreshTimeline(){
        const ns=await Store.getAll('notes'); const bs=await Store.getAll('books'); const c=document.getElementById('timeline-content'); c.innerHTML=''; const filterId = document.getElementById('timeline-filter').value;
        if(ns.length==0){c.innerHTML='<div style="text-align:center;color:#a4b0be;margin-top:50px;font-size:15px">æš‚æ— ä»»ä½•ç¬”è®°è®°å½•</div>';return}
        const gs={}; ns.forEach(n=>{ if(filterId !== 'all' && n.bookId !== filterId) return; if(!gs[n.bookId]) gs[n.bookId]=[]; gs[n.bookId].push(n); });
        if(Object.keys(gs).length === 0) { c.innerHTML='<div style="text-align:center;color:#a4b0be;margin-top:50px">è¯¥ä¹¦ä¸‹æš‚æ— ç¬”è®°</div>'; return; }
        Object.keys(gs).forEach(bid=>{
            const b=bs.find(x=>x.id==bid); const g=document.createElement('div'); g.className='tl-book-group';
            g.innerHTML=`<div class="tl-header" onclick="this.parentElement.classList.toggle('collapsed')"><span class="tl-title">ğŸ“– ${b?b.title:'æœªçŸ¥'} <small style="color:#888;font-weight:normal;background:rgba(0,0,0,0.05);padding:2px 8px;border-radius:10px">${gs[bid].length} æ¡</small></span><span class="tl-arrow">â–¼</span></div><div class="tl-notes-container"></div>`;
            const ct=g.querySelector('.tl-notes-container');
            gs[bid].sort((a,b)=>b.time-a.time).forEach(n=>{
                const d=document.createElement('div'); d.className='tl-note-item'; d.innerHTML=`<div style="color:#555;font-weight:bold;margin-bottom:6px">"${n.quote}"</div><div style="font-size:13px;color:#888;line-height:1.5">${(n.messages[n.messages.length-1]?.content||'æš‚æ— å¯¹è¯').slice(0,50)}...</div>`;
                initTimelineItem(d, n.id); d.onclick=async()=>{ if(isLongPress) return; const bk=await Store.get('books',n.bookId); if(bk){ switchTab('shelf'); openReader(bk); setTimeout(()=>openSidebar(n),400); } }; ct.appendChild(d);
            }); c.appendChild(g);
        });
    }

    let longPressTimer, isLongPress, targetNoteId;
    function initTimelineItem(el, nid) {
        const start = () => { isLongPress=false; longPressTimer=setTimeout(()=>{isLongPress=true;el.style.background='rgba(255,118,117,0.1)';if(navigator.vibrate)navigator.vibrate(50);showActionSheet(nid)},600); };
        const end = () => { clearTimeout(longPressTimer); setTimeout(()=>el.style.background='',300); };
        el.addEventListener('touchstart', start); el.addEventListener('touchend', end); el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
    }
    function showActionSheet(nid) { targetNoteId=nid; document.getElementById('as-mask').classList.add('active'); document.getElementById('action-sheet').classList.add('active'); document.getElementById('as-del-btn').onclick=async()=>{ if(!targetNoteId)return; await Store.del('notes',targetNoteId); closeActionSheet(); refreshTimeline(); showToast("ğŸ—‘ï¸ å·²åˆ é™¤"); }; }
    function closeActionSheet(){ document.getElementById('as-mask').classList.remove('active'); document.getElementById('action-sheet').classList.remove('active'); }

    async function triggerAI(n) {
        if(!GS.key) return showToast("âš ï¸ è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");
        openSidebar(n); const l=document.getElementById('chat-list');
        const loadDiv = document.createElement('div'); loadDiv.className='msg-container ai'; loadDiv.innerHTML=`<div class="msg-bubble"><div style="height:14px;width:100px;background:rgba(0,0,0,0.05);border-radius:10px;animation:pulse 1.5s infinite"></div></div><style>@keyframes pulse{0%,100%{opacity:0.5}50%{opacity:1}}</style>`; l.appendChild(loadDiv); l.scrollTop=l.scrollHeight;
        const memoryText = (currentBook.memories||[]).map((m,i)=>`${i+1}. ${m}`).join('\n'); const systemPrompt = `${GS.persona}\nä¹¦æœ¬è®°å¿†ï¼š${memoryText}\nèƒŒæ™¯ï¼š${currentBook.context}`;
        const msgs =[ {role:'system', content: systemPrompt}, ...n.messages.map(m=>({role:m.role=='ai'?'assistant':'user', content:m.content})) ]; if(n.messages.length===0) msgs.push({role:'user', content:`æˆ‘è¯»åˆ°äº†è¿™æ®µï¼š\n"${n.quote}"\n\nä½ æ€ä¹ˆçœ‹ï¼Ÿ`});
        let fullText = "";
        try { await callAPIStream(msgs, (chunk) => { fullText += chunk; loadDiv.innerHTML = `<div class="msg-bubble">${formatText(fullText)}<span class="cursor"></span></div>`; l.scrollTop = l.scrollHeight; }); loadDiv.innerHTML = `<div class="msg-bubble">${formatText(fullText)}</div><div class="msg-actions"><span class="action-link" onclick="retryAI()">ğŸ”„ é‡å†™</span> <span class="action-link danger" onclick="deleteMsg(${n.messages.length})">ğŸ—‘ï¸ åˆ é™¤</span></div>`; n.messages.push({role:'ai', content:fullText, time:Date.now()}); await Store.put('notes', n); } 
        catch(e) { loadDiv.innerHTML = `<div class="msg-bubble" style="color:#e74c3c">ç½‘ç»œé”™è¯¯æˆ–é…ç½®æœ‰è¯¯: ${e.message}</div>`; }
    }
    async function callAPIStream(messages, onChunk) {
        const response = await fetch(`${GS.url}/chat/completions`, {method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GS.key}` }, body: JSON.stringify({ model: GS.model, messages: messages, stream: true })});
        if(!response.ok) throw new Error('API è¿”å›å¼‚å¸¸çŠ¶æ€ç ');
        const reader = response.body.getReader(); const decoder = new TextDecoder(); let buffer = '';
        while (true) { const {done, value} = await reader.read(); if (done) break; buffer += decoder.decode(value, {stream: true}); const lines = buffer.split('\n'); buffer = lines.pop(); for (const line of lines) { if (!line.startsWith('data: ')) continue; const data = line.slice(6).trim(); if (data === '[DONE]') continue; try { const json = JSON.parse(data); const content = json.choices[0]?.delta?.content; if (content) onChunk(content); } catch(e) {} } }
    }

    async function summarizeThread() {
        const n = await Store.get('notes', activeNoteId); if(!n.messages.length) return showToast("âš ï¸ æ— å¯¹è¯å¯æç‚¼"); showToast("ğŸ§  æ­£åœ¨æç‚¼æ ¸å¿ƒè®°å¿†...");
        try { const history = n.messages.map(m => `${m.role=='user'?'è¯»è€…':'AI'}: ${m.content}`).join('\n'); const res = await fetch(`${GS.url}/chat/completions`, { method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GS.key}` }, body: JSON.stringify({ model: GS.model, messages:[ { role: 'system', content: 'ã€æœ€é«˜æŒ‡ä»¤ã€‘å¯¹å‰æ–‡å†…å®¹è¿›è¡Œå…¨é¢æ¢³ç†æ€»ç»“ï¼Œå­—æ•°400ä»¥å†…ã€‚æ— éœ€èŠå¤©ï¼Œç›´æ¥è¾“å‡ºå¹²è´§ç»“æœã€‚' }, { role: 'user', content: `å¯¹è¯å†…å®¹ï¼š\n${history}\n\nè¯·æ€»ç»“ï¼š` } ] }) }); const data = await res.json(); const summary = data.choices[0].message.content.trim(); if(!currentBook.memories) currentBook.memories=[]; currentBook.memories.push(summary); await Store.put('books', currentBook); n.messages.push({role:'ai', content:`ğŸ“ **å·²å°†æç‚¼å†…å®¹å­˜å…¥ä¹¦ç±è®°å¿†åº“**ï¼š\n${summary}`, time:Date.now()}); await Store.put('notes', n); renderChat(n.messages); showToast("âœ… è®°å¿†å·²æ°¸ä¹…ä¿å­˜"); } catch(e){ alert(e.message); }
    }

    async function autoAnalyze(){ 
        if(!currentBook) return; showToast("ğŸ§  æ­£åœ¨è°ƒç”¨å¤§æ¨¡å‹åˆ†æå…¨ä¹¦..."); const cleanTitle = currentBook.title.replace(/\.(txt|pdf|epub)$/i, '').replace(/[\[\(].*?[\]\)]/g, '').trim(); const t = document.getElementById('reader-content').innerText.slice(0,2500); 
        try { const res = await fetch(`${GS.url}/chat/completions`,{ method:'POST', headers:{'Content-Type':'application/json','Authorization':`Bearer ${GS.key}`}, body:JSON.stringify({ model:GS.model, messages:[ { role: 'system', content: 'ä½ æ˜¯æ–‡å­¦è¯„è®ºå®¶ã€‚ä¼˜å…ˆä»çŸ¥è¯†åº“æ£€ç´¢è¯¥ä¹¦ã€‚å¦‚æœä¸çŸ¥é“ï¼Œæ ¹æ®å¼€å¤´æ¨æ–­ã€‚' }, { role:'user', content:`åˆ†æä¹¦ç±ã€Š${cleanTitle}ã€‹ã€‚\nç›´æ¥ä»‹ç»æ ¸å¿ƒå‰§æƒ…ã€äººç‰©å…³ç³»å’Œçœ‹ç‚¹ï¼ˆ300å­—ï¼‰ã€‚\nå¦‚ä¸çŸ¥é“ï¼Œæ ¹æ®å¼€å¤´æ¨æ–­ï¼š\n${t}` } ] }) }).then(r=>r.json()); document.getElementById('current-book-context').value = res.choices[0].message.content; saveBookConfig(); showToast("âœ… è‡ªåŠ¨åˆ†æå®Œæˆï¼"); } catch(e){ alert("è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API"); }
    }

    function formatText(t){ return t.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g,'<br>'); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); }
    function safeCopy(text) { const ta = document.createElement("textarea"); ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); showToast("âœ… å·²å¤åˆ¶"); } catch (e) {} document.body.removeChild(ta); }
    async function sendMsg(tai) { const i=document.getElementById('chat-input'); const t=i.value.trim(); const n=await Store.get('notes', activeNoteId); if(t){ n.messages.push({role:'user',content:t,time:Date.now()}); await Store.put('notes',n); renderChat(n.messages); i.value=''; } if(tai) triggerAI(n); }
    async function deleteMsg(idx) { if(!confirm('åˆ é™¤ï¼Ÿ'))return; const n = await Store.get('notes', activeNoteId); n.messages.splice(idx, 1); await Store.put('notes', n); renderChat(n.messages); }
    async function editMsg(idx) { const n = await Store.get('notes', activeNoteId); const t = prompt("Edit:", n.messages[idx].content); if(t!==null){ n.messages[idx].content=t; await Store.put('notes', n); renderChat(n.messages); } }
    async function retryAI() { const n = await Store.get('notes', activeNoteId); if(n.messages.at(-1).role==='ai'){ n.messages.pop(); await Store.put('notes', n); renderChat(n.messages); triggerAI(n); } }
    
    function openBookConfig(){if(!currentBook)return;document.getElementById('current-book-context').value=currentBook.context||'';renderMemories();document.getElementById('book-config-modal').style.display='flex';}
    function saveBookConfig(){currentBook.context=document.getElementById('current-book-context').value;Store.put('books',currentBook);}
    function renderMemories(){ const list = document.getElementById('memory-list'); list.innerHTML = ''; (currentBook.memories ||[]).forEach((m, i) => { const div = document.createElement('div'); div.innerHTML = `<div style="background:rgba(255,255,255,0.6);border-left:4px solid #f1c40f;padding:15px;margin-bottom:12px;border-radius:0 12px 12px 0;position:relative;box-shadow:0 2px 10px rgba(0,0,0,0.02)"><div contenteditable="true" onblur="updateMemory(${i}, this.innerText)" style="outline:none;line-height:1.5">${m.replace(/</g,'&lt;')}</div><div style="position:absolute;top:5px;right:5px;padding:5px 10px;color:#ff7675;cursor:pointer;font-size:18px" onclick="deleteMemory(${i})">Ã—</div></div>`; list.appendChild(div.firstChild); }); }
    async function updateMemory(idx, text){ currentBook.memories[idx] = text; await Store.put('books', currentBook); }
    async function deleteMemory(idx){ if(confirm("åˆ é™¤è¿™æ¡è®°å¿†?")){ currentBook.memories.splice(idx, 1); await Store.put('books', currentBook); renderMemories(); } }
    async function addEmptyMemory(){ if(!currentBook.memories) currentBook.memories=[]; currentBook.memories.push("ç‚¹æ­¤è¾“å…¥æ–°è®°å¿†..."); await Store.put('books', currentBook); renderMemories(); }
    
    document.getElementById('file-in').addEventListener('change', async e=>{const f=e.target.files[0];if(!f)return;showToast("æ­£åœ¨ç–¯ç‹‚è§£æä¸­...");try{let c='',t=f.name.split('.').pop().toLowerCase();if(t=='txt')c=formatTxt(await readFile(f));else if(t=='pdf')c=formatPdf(await parsePdf(f));else if(t=='epub')c=formatTxt(await parseEpub(f));await Store.put('books',{id:Date.now().toString(),title:f.name,type:t,content:c,scroll:0,context:'',memories:[],color:`hsl(${Math.random()*360},60%,70%)`});refreshShelf(); openBookConfig();}catch(x){alert(x.message)}});
    function readFile(f){return new Promise(r=>{const reader=new FileReader();reader.onload=e=>{const decoder=new TextDecoder(GS.encoding||'utf-8');r(decoder.decode(e.target.result));};reader.readAsArrayBuffer(f);})}
    function readArr(f){return new Promise(r=>{const d=new FileReader();d.onload=e=>r(e.target.result);d.readAsArrayBuffer(f)})}
    async function parsePdf(f){const p=await pdfjsLib.getDocument({data:await readArr(f)}).promise;let t='';for(let i=1;i<=p.numPages;i++)t+=(await(await p.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ')+'\n\n';return formatPdf(t)}
    async function parseEpub(f){const z=await JSZip.loadAsync(await readArr(f));const p=new DOMParser();let t='';for(let k in z.files)if(k.match(/\.x?html$/))t+=p.parseFromString(await z.file(k).async('string'),'text/html').body.innerText+'\n\n';return t}
    function formatTxt(t){return t.split('\n').filter(s=>s.trim()).map(s=>`<p>${s}</p>`).join('')}
    function formatPdf(t){return t.split('\n').map(s=>s.trim()?`<p>${s}</p>`:'<br>').join('')}
    
    function delBook(e,id){e.stopPropagation();if(confirm('åˆ é™¤ä¹¦å’Œç¬”è®°ï¼Ÿ'))Store.del('books',id).then(refreshShelf)}
    function switchTab(t){
        document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.view-page').forEach(e=>e.classList.remove('active'));
        const map = {'shelf':0, 'timeline':1, 'persona':2, 'settings':3};
        document.querySelectorAll('.tab-item')[map[t]].classList.add('active');
        document.getElementById(`view-${t}`).classList.add('active');
        if(t=='timeline') refreshTimeline();
    }
    let st; function handleScroll(){ if(st)return; st=setTimeout(()=>{st=null; if(currentBook){currentBook.scroll=document.getElementById('reader-content').scrollTop;Store.put('books',currentBook)}},1000); }
    window.addEventListener('beforeunload',()=>{if(currentBook){currentBook.scroll=document.getElementById('reader-content').scrollTop;Store.put('books',currentBook)}});
    
    initDB();
</script>
</body>
</html>
