<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SoulReader V32 (å…¨çŸ¥å…¨èƒ½ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>

    <style>
        :root { 
            --bg: #f8f5e6; --accent: #d35400; --text: #2c3e50; 
            --mark-bg: #ffeaa7; --ai-bubble: #ffffff; --user-bubble: #e17055; 
            --safe-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'PingFang SC', serif; margin: 0; height: 100vh; background: var(--bg); color: var(--text); overflow: hidden; display: flex; flex-direction: column; padding-bottom: var(--safe-bottom); }
        
        /* å¸ƒå±€ */
        #tab-bar { height: 60px; background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: space-around; align-items: center; flex-shrink: 0; z-index: 900; }
        .tab-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #999; flex: 1; height: 100%; justify-content: center; transition: transform 0.1s; }
        .tab-item:active { transform: scale(0.95); }
        .tab-item.active { color: var(--accent); font-weight: bold; }
        #main-view { flex: 1; overflow: hidden; position: relative; }
        .view-page { position: absolute; inset: 0; display: none; flex-direction: column; background: var(--bg); overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .view-page.active { display: flex; }

        /* é˜…è¯»å™¨ */
        #reader-overlay { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; flex-direction: column; padding-bottom: var(--safe-bottom); }
        #reader-overlay.active { display: flex; }
        #reader-header { height: 50px; background: rgba(248,245,230,0.98); border-bottom: 1px solid #ccc; display: flex; justify-content: space-between; align-items: center; padding: 0 15px; flex-shrink: 0; }
        #reader-content { 
            flex: 1; overflow-y: auto; 
            padding: 20px 20px 120px; 
            font-size: 19px; line-height: 1.8; text-align: justify; 
            user-select: text; -webkit-user-select: text; 
        }

/* ç›®å½•ä¾§è¾¹æ  */
#toc-sidebar { position: fixed; top: 0; left: 0; width: 75%; max-width: 320px; height: 100%; background: #fff; z-index: 4500; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); transform: translateX(-100%); display: flex; flex-direction: column; box-shadow: 5px 0 30px rgba(0,0,0,0.15); }
#toc-sidebar.active { transform: translateX(0); }
.toc-item { padding: 15px 20px; border-bottom: 1px solid #f5f5f5; font-size: 15px; color: #333; cursor: pointer; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background 0.2s; }
.toc-item:active { background: #f0f0f0; }
        
        /* ä¾§è¾¹æ  */
        #sidebar { position: fixed; top: 0; right: 0; width: 100%; height: 100%; max-width: 450px; background: #f4f4f4; z-index: 4000; transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1); transform: translateX(100%); display: flex; flex-direction: column; box-shadow: -5px 0 30px rgba(0,0,0,0.2); }
        #sidebar.active { transform: translateX(0); }
        
        /* èŠå¤©æ°”æ³¡ */
        .msg-container { margin-bottom: 15px; display: flex; flex-direction: column; width: 100%; }
        .msg-bubble { max-width: 88%; padding: 12px 14px; border-radius: 12px; font-size: 15px; line-height: 1.6; position: relative; word-wrap: break-word; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .msg-container.ai { align-items: flex-start; }
        .msg-container.ai .msg-bubble { background: var(--ai-bubble); border-bottom-left-radius: 2px; }
        .msg-container.user { align-items: flex-end; }
        .msg-container.user .msg-bubble { background: var(--user-bubble); color: white; border-bottom-right-radius: 2px; }
        
        /* æ“ä½œæ  */
        .msg-actions { display: flex; gap: 12px; margin-top: 6px; padding: 0 5px; font-size: 12px; color: #888; }
        .action-link { cursor: pointer; display: flex; align-items: center; gap: 2px; transition: color 0.2s; }
        .action-link:hover { color: var(--accent); }
        .action-link.danger { color: #e74c3c; }

        /* æ‚¬æµ®å */
        #floating-dock { position: fixed; right: -250px; top: 40%; background: #2d3436; color: white; border-radius: 50px 0 0 50px; padding: 5px; z-index: 3000; transition: right 0.1s; display: flex; flex-direction: column; gap: 1px; border-left: 4px solid var(--accent); box-shadow: 0 5px 20px rgba(0,0,0,0.3); }
        #floating-dock.visible { right: 0; }
        .dock-btn { padding: 15px 25px; font-weight: bold; font-size: 15px; white-space: nowrap; cursor: pointer; user-select: none; transition: background 0.2s; }
        .dock-btn:active { background: #444; }

        /* é«˜äº®æ ‡è®° */
        mark.ai-mark { background: var(--mark-bg); color: inherit; cursor: pointer; border-bottom: 2px solid #e67e22; padding-bottom: 0; margin: 0; }
        .ai-anchor { display: inline-flex; width: 20px; height: 20px; background: var(--accent); color: white; border-radius: 50%; font-size: 10px; justify-content: center; align-items: center; margin-right: 4px; vertical-align: middle; cursor: pointer; }
        
        /* Utils */
        .btn { background: #2d3436; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-size: 14px; cursor: pointer; }
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-family: inherit; }
        #toast { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.85); color: white; padding: 15px 25px; border-radius: 8px; font-size: 15px; z-index: 9999; display: none; text-align:center; max-width: 80%; pointer-events: none; }
        
        /* æ¨¡æ€æ¡† */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 5000; justify-content: center; align-items: flex-end; }
        .modal-box { background: white; width: 100%; height: 90vh; border-radius: 20px 20px 0 0; display:flex; flex-direction:column; animation: slideUp 0.3s ease; padding-bottom: var(--safe-bottom); }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* ä¹¦æ¶ */
        #shelf-list { padding: 20px; display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; padding-bottom: 100px; }
        .book-cover { aspect-ratio: 2/3; background: #8e44ad; border-radius: 8px; color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 10px; text-align: center; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1); cursor: pointer; }

        /* Timeline Groups */
        .tl-book-group { background: white; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); overflow: hidden; border: 1px solid #eee; }
        .tl-header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: #fff; cursor: pointer; transition: background 0.2s; }
        .tl-header:active { background: #f9f9f9; }
        .tl-title { font-weight: bold; font-size: 15px; color: #333; display: flex; align-items: center; gap: 8px; }
        .tl-arrow { transition: transform 0.3s ease; color: #999; font-size: 12px; }
        .tl-book-group.collapsed .tl-notes-container { display: none; }
        .tl-book-group.collapsed .tl-arrow { transform: rotate(-90deg); }
        
        /* Timeline Items */
        .tl-note-item { padding: 15px; border-top: 1px solid #f0f0f0; transition: background 0.2s; position: relative; background: #fafafa; }
        .tl-note-item:active { background: #f0f0f0; transform: scale(0.99); }
        .tl-note-item.long-pressed { background: #ffebeb; }

        /* Action Sheet */
        #action-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; z-index: 6000; border-radius: 20px 20px 0 0; box-shadow: 0 -5px 30px rgba(0,0,0,0.2); transform: translateY(100%); transition: transform 0.2s; padding-bottom: max(20px, var(--safe-bottom)); }
        #action-sheet.active { transform: translateY(0); }
        .as-header { padding: 15px; text-align: center; color: #999; font-size: 12px; border-bottom: 1px solid #eee; }
        .as-btn { display: block; width: 100%; padding: 18px; text-align: center; font-size: 16px; border: none; background: white; color: #333; }
        .as-btn:active { background: #f5f5f5; }
        .as-btn.danger { color: #e74c3c; font-weight: bold; }
        #as-mask { position: fixed; inset: 0; background: rgba(0,0,0,0.4); z-index: 5999; display: none; opacity: 0; transition: opacity 0.2s; }
        #as-mask.active { display: block; opacity: 1; }
    </style>
</head>
<body>

<div id="toast"></div>

<!-- Action Sheet -->
<div id="as-mask" onclick="closeActionSheet()"></div>
<div id="action-sheet">
    <div class="as-header">é€‰æ‹©æ“ä½œ</div>
    <button class="as-btn danger" id="as-del-btn">ğŸ—‘ï¸ åˆ é™¤è¿™æ¡ç¬”è®°</button>
    <div style="height:8px;background:#f5f5f5"></div>
    <button class="as-btn" onclick="closeActionSheet()">å–æ¶ˆ</button>
</div>

<!-- Loader -->
<div id="loader" style="display:none;position:fixed;inset:0;background:rgba(255,255,255,0.95);z-index:6000;justify-content:center;align-items:center;flex-direction:column">
    <div style="font-size:30px;animation:spin 1s linear infinite">ğŸ§ </div>
    <div style="margin:15px;color:#555;font-weight:bold" id="loader-text">AI æ­£åœ¨æ€è€ƒ...</div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
</div>

<!-- Tab Bar -->
<div id="tab-bar">
    <div class="tab-item active" onclick="switchTab('shelf')"><div style="font-size:20px">ğŸ“š</div><div>ä¹¦æ¶</div></div>
    <div class="tab-item" onclick="switchTab('timeline')"><div style="font-size:20px">ğŸ“‚</div><div>å½’æ¡£</div></div>
    <div class="tab-item" onclick="switchTab('settings')"><div style="font-size:20px">âš™ï¸</div><div>è®¾ç½®</div></div>
</div>

<!-- Main Views -->
<div id="main-view">
    <div id="view-shelf" class="view-page active">
        <div style="padding:20px; display:flex; justify-content:space-between; align-items:center;">
            <span style="font-weight:bold;font-size:1.2rem">æˆ‘çš„è—ä¹¦</span>
            <button class="btn" onclick="document.getElementById('file-in').click()">â• å¯¼å…¥æ–‡ä»¶</button>
            <input type="file" id="file-in" hidden accept=".txt,.pdf,.epub">
        </div>
        <div id="shelf-list"></div>
        <div id="empty-tip" style="text-align:center;padding:50px;color:#999;display:none">
            ğŸ“š ä¹¦æ¶ç©ºç©ºçš„ï¼Ÿ<br>å¦‚æœä½ ä¹‹å‰æœ‰ä¹¦ï¼Œè¯·å»ã€è®¾ç½®ã€‘é‡Œåˆ‡æ¢æ•°æ®åº“æ‰¾å›ï¼
        </div>
    </div>
    
    <div id="view-timeline" class="view-page">
        <!-- é¡¶éƒ¨ç­›é€‰æ  -->
        <div style="padding:15px;background:#fff;border-bottom:1px solid #eee;position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 5px rgba(0,0,0,0.02)">
            <select id="timeline-filter" onchange="refreshTimeline()" style="margin:0;border:none;background:transparent;font-weight:bold;color:#d35400;font-size:16px;padding-right:20px;width:auto">
                <option value="all">ğŸ“‚ å…¨éƒ¨ç¬”è®°</option>
            </select>
            <span style="font-size:11px;color:#999">é•¿æŒ‰ç®¡ç†</span>
        </div>
        <div id="timeline-content" style="padding:15px"></div>
    </div>

    <div id="view-settings" class="view-page">
        <div style="padding:20px;padding-bottom:100px">
            <h3>âš™ï¸ è®¾ç½®</h3>
            
            <div style="background:#fff8e1;padding:10px;border-radius:8px;margin-bottom:15px;border:1px solid #ffe0b2">
                <label style="font-weight:bold;display:block;margin-bottom:5px;color:#d35400">ğŸ“„ TXT ç¼–ç æ ¼å¼</label>
                <div style="font-size:12px;color:#888;margin-bottom:5px">å¦‚æœå¯¼å…¥æ˜¯ä¹±ç ï¼Œè¯·åˆ‡æ¢ä¸º GBK åé‡æ–°å¯¼å…¥</div>
                <select id="encoding-select" onchange="saveGS()" style="margin:0;border-color:#d35400">
                    <option value="utf-8">UTF-8 (é»˜è®¤/é€šç”¨)</option>
                    <option value="gbk">GBK (ä¸­æ–‡/è€æ–‡ä»¶)</option>
                </select>
            </div>

            <label>API Key</label><input type="password" id="api-key" onchange="saveGS()" placeholder="sk-...">
            <label>API URL</label><input type="text" id="api-url" onchange="saveGS()" placeholder="https://api.openai.com/v1">
            <label>æ¨¡å‹</label><select id="model-select" onchange="saveGS()"></select>
            <label>é»˜è®¤äººè®¾</label><textarea id="default-persona" rows="4" onchange="saveGS()"></textarea>
            <button class="btn" onclick="fetchModels()">ğŸ”„ åˆ·æ–°æ¨¡å‹</button>

            <hr style="border:0;border-top:1px dashed #ccc;margin:20px 0">
            
            <div style="background:#ecf0f1;padding:15px;border-radius:8px">
                <label style="font-weight:bold;color:#2c3e50">ğŸ’¾ æ•°æ®æ‰¾å› / åˆ‡æ¢ä»“åº“</label>
                <div style="font-size:12px;color:#666;margin-bottom:10px">
                    ä¹¦ä¸è§äº†ï¼Ÿå¯èƒ½åœ¨æ—§ä»“åº“é‡Œã€‚<br>è¯•è¯•è¾“å…¥ï¼š<b>SoulReaderV20</b> æˆ– <b>SoulReaderV27</b>
                </div>
                <div style="display:flex;gap:10px">
                    <input type="text" id="db-name-input" placeholder="è¾“å…¥ä»“åº“å..." style="margin:0">
                    <button class="btn" style="background:#34495e" onclick="switchDB()">åˆ‡æ¢å¹¶åŠ è½½</button>
                </div>
                <div style="font-size:12px;color:#999;margin-top:5px">å½“å‰ä»“åº“: <span id="current-db-display" style="font-weight:bold"></span></div>
            </div>
        </div>
    </div>
</div>

<!-- Reader -->
    <div id="reader-overlay">
    <div id="reader-header">
        <button class="btn" style="background:transparent;color:#333;font-size:20px;padding:0;width:30px" onclick="closeReader()">â¬…</button>
        <!-- æ–°å¢ç›®å½•æŒ‰é’® -->
        <button class="btn" style="background:transparent;color:#d35400;font-size:20px;padding:0;width:40px" onclick="document.getElementById('toc-sidebar').classList.add('active')">ğŸ“‘</button>
        <span id="book-title-header" style="font-weight:bold;flex:1;text-align:center;margin:0 10px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis"></span>
        <button class="btn" style="background:#f1c40f;color:#333;padding:5px 12px;font-size:12px;font-weight:bold" onclick="openBookConfig()">ğŸ§  è®¾å®š</button>
    </div>
    
    <!-- æ–°å¢ï¼šç›®å½•ä¾§è¾¹æ  -->
    <div id="toc-sidebar">
        <div style="padding:15px 20px;background:#f8f5e6;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;height:50px;">
            <span style="font-weight:bold;color:#d35400;">ğŸ“‘ æ™ºèƒ½ç›®å½•</span>
            <button onclick="document.getElementById('toc-sidebar').classList.remove('active')" style="border:none;background:none;font-size:24px;color:#999;cursor:pointer;">Ã—</button>
        </div>
        <div id="toc-list" style="flex:1;overflow-y:auto;background:#fff;padding-bottom:var(--safe-bottom);"></div>
    </div>

    <div id="reader-content" onscroll="handleScroll()"></div>
    <div id="floating-dock">
        <div class="dock-btn" id="btn-ai">âš¡ AI åæ§½</div>
        <div style="height:1px;background:rgba(255,255,255,0.2);margin:0 10px"></div>
        <div class="dock-btn" id="btn-user">âœï¸ è‡ªå·±å†™</div>
    </div>
</div>

<!-- Sidebar -->
<div id="sidebar">
    <div style="padding:10px 15px;background:#fff;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;height:55px;box-shadow:0 2px 5px rgba(0,0,0,0.05)">
        <span style="font-weight:bold">ğŸ“ æ‰¹æ³¨è¯¦æƒ…</span>
        <div style="display:flex;gap:10px">
            <button class="btn" style="background:#e67e22;padding:5px 10px;font-size:12px" onclick="summarizeThread()">âœ¨ æ€»ç»“å¯¹è¯</button>
            <button onclick="document.getElementById('sidebar').classList.remove('active')" style="border:none;background:none;font-size:24px;color:#777">Ã—</button>
        </div>
    </div>
    
    <div id="chat-quote-container" style="padding:15px;background:#fafafa;border-bottom:1px solid #eee;">
        <div style="font-size:12px;color:#999;margin-bottom:5px">åŸæ–‡ï¼š</div>
        <div id="chat-quote" style="font-style:italic;color:#555;font-size:14px;line-height:1.4;max-height:80px;overflow-y:auto;border-left:3px solid #ccc;padding-left:8px"></div>
    </div>

    <div id="chat-list" style="flex:1;overflow-y:auto;padding:15px;background:#f4f4f4"></div>

    <div style="padding:10px;background:white;border-top:1px solid #ddd;display:flex;flex-direction:column;gap:8px">
        <textarea id="chat-input" rows="1" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." style="margin:0;min-height:40px;resize:none;padding:10px;background:#f9f9f9;border:1px solid #ddd;border-radius:20px"></textarea>
        <div style="display:flex;justify-content:flex-end;gap:10px">
            <button class="btn" style="background:#95a5a6;padding:6px 15px;border-radius:20px" onclick="sendMsg(false)">å­˜ç¬”è®°</button>
            <button class="btn" style="background:var(--accent);padding:6px 15px;border-radius:20px" onclick="sendMsg(true)">âœ¨ å‘é€</button>
        </div>
    </div>
</div>

<!-- Config Modal -->
<div id="book-config-modal" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-box">
        <div style="padding:15px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;font-weight:bold;background:#fff">
            <span>ğŸ“˜ ä¹¦ç±å¤§è„‘ (Memory)</span>
            <span onclick="document.getElementById('book-config-modal').style.display='none'" style="cursor:pointer;font-size:20px">Ã—</span>
        </div>
        <div style="flex:1;overflow-y:auto;padding:20px;background:#fcfcfc">
            <div style="background:white;padding:15px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:20px">
                 <label style="font-size:14px;font-weight:bold;display:block;margin-bottom:10px">ğŸ“š ä¹¦ç±èƒŒæ™¯/æ‘˜è¦</label>
                 <textarea id="current-book-context" rows="3" placeholder="è¿™æœ¬ä¹¦è®²äº†ä»€ä¹ˆ..." onchange="saveBookConfig()"></textarea>
                 <button class="btn" style="width:100%;margin-top:10px;background:#e67e22" onclick="autoAnalyze()">âœ¨ è‡ªåŠ¨åˆ†æå…¨ä¹¦èƒŒæ™¯</button>
            </div>
            <div style="font-size:14px;font-weight:bold;margin-bottom:10px;color:#333">ğŸ§  é•¿æœŸè®°å¿†å¡ç‰‡</div>
            <div id="memory-list"></div>
            <button class="btn" style="width:100%;margin-top:10px;background:#bdc3c7;color:#333;border:1px dashed #999" onclick="addEmptyMemory()">+ æ·»åŠ è®°å¿†å¡ç‰‡</button>
        </div>
    </div>
</div>

<script>
    // --- Core Logic ---
    let DB_NAME = localStorage.getItem('sr_dbname') || 'SoulReaderV20';
    let db, currentBook=null, activeNoteId=null;
    const GS={url:localStorage.getItem('sr_url')||'https://api.openai.com/v1', key:localStorage.getItem('sr_key')||'', model:localStorage.getItem('sr_model')||'gpt-3.5-turbo', persona:localStorage.getItem('sr_persona')||'ä½ æ˜¯ä¸€ä¸ªæ¯’èˆŒä¹¦è¯„äººï¼Œå–œæ¬¢ç”¨çŠ€åˆ©å¹½é»˜çš„è¯­è¨€ç‚¹è¯„ä¹¦ç±ç‰‡æ®µã€‚', encoding: localStorage.getItem('sr_encoding')||'utf-8'};
    
    // Init Settings
    document.getElementById('api-url').value=GS.url; document.getElementById('api-key').value=GS.key; document.getElementById('default-persona').value=GS.persona; document.getElementById('model-select').innerHTML=`<option>${GS.model}</option>`;
    document.getElementById('encoding-select').value = GS.encoding;
    document.getElementById('db-name-input').value = DB_NAME;
    document.getElementById('current-db-display').innerText = DB_NAME;

    window.openSidebarById = async function(id) { const n=await Store.get('notes',id); if(n) openSidebar(n); };

    function switchDB() {
        const newName = document.getElementById('db-name-input').value.trim();
        if(!newName || newName === DB_NAME) return;
        if(confirm(`åˆ‡æ¢åˆ° "${newName}" å—ï¼Ÿ`)) { localStorage.setItem('sr_dbname', newName); location.reload(); }
    }

    function initDB(){return new Promise(r=>{
        const q=indexedDB.open(DB_NAME,2); 
        q.onupgradeneeded=e=>{db=e.target.result; if(!db.objectStoreNames.contains('books'))db.createObjectStore('books',{keyPath:'id'}); if(!db.objectStoreNames.contains('notes')){const n=db.createObjectStore('notes',{keyPath:'id'});n.createIndex('bookId','bookId',{unique:false})}};
        q.onsuccess=e=>{db=e.target.result;r();refreshShelf();refreshTimeline();};
    })}
    const Store={put:(t,d)=>new Promise(r=>{const x=db.transaction(t,'readwrite');x.objectStore(t).put(d);x.oncomplete=r}),getAll:t=>new Promise(r=>{const x=db.transaction(t,'readonly');x.objectStore(t).getAll().onsuccess=e=>r(e.target.result)}),get:(t,id)=>new Promise(r=>{const x=db.transaction(t,'readonly');x.objectStore(t).get(id).onsuccess=e=>r(e.target.result)}),del:(t,id)=>new Promise(r=>{const x=db.transaction(t,'readwrite');x.objectStore(t).delete(id);x.oncomplete=r})};

    async function refreshShelf(){
        const bs=await Store.getAll('books');
        const l=document.getElementById('shelf-list'); l.innerHTML='';
        document.getElementById('empty-tip').style.display = bs.length ? 'none' : 'block';
        const filter = document.getElementById('timeline-filter');
        const currentVal = filter.value;
        filter.innerHTML = '<option value="all">ğŸ“‚ å…¨éƒ¨ç¬”è®°</option>';
        bs.forEach(b => {
            const op = document.createElement('option'); op.value = b.id; op.innerText = `ğŸ“– ${b.title}`; filter.appendChild(op);
            const d=document.createElement('div');d.className='book-cover';d.style.background=b.color;
            d.innerHTML=`<div style="font-weight:bold;overflow:hidden;max-height:60px;line-height:1.2">${b.title}</div><div style="font-size:10px;margin-top:5px;opacity:0.8">${b.type.toUpperCase()}</div><div onclick="delBook(event,'${b.id}')" style="position:absolute;top:-8px;right:-8px;background:rgba(231,76,60,0.9);color:white;width:24px;height:24px;border-radius:50%;line-height:22px;cursor:pointer;font-weight:bold;font-size:14px;box-shadow:0 2px 5px rgba(0,0,0,0.2)">Ã—</div>`;
            d.onclick=e=>{if(!e.target.innerText.includes('Ã—'))openReader(b)}; l.appendChild(d);
        });
        if(currentVal && Array.from(filter.options).some(o=>o.value==currentVal)) filter.value = currentVal;
    }
    
    async function openReader(b){
        currentBook=b; if(!currentBook.memories) currentBook.memories=[];
        document.getElementById('reader-overlay').classList.add('active');
        document.getElementById('book-title-header').innerText=b.title;
        
        // --- ğŸ¤– æ ¸å¿ƒï¼šæ™ºèƒ½æå–ç›®å½• ---
        let tempContent = b.content;
        let tocHTML = '';
        let chapIdx = 0;
        
        // ä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼šç¬¬ä¸€ç« ã€ç¬¬12å›ã€Chapter 1ã€ç•ªå¤–ç­‰ï¼Œå¹¶é™åˆ¶å­—æ•°é˜²æ­¢è¯¯åˆ¤æ­£æ–‡
        const chapRegex = /<p>\s*(ç¬¬[\u4e00-\u9fa50-9é›¶ä¸€äºŒä¸‰å››äº”å…­ä¸ƒå…«ä¹åç™¾åƒä¸‡]+[ç« å›èŠ‚å·éƒ¨].{0,30}|Chapter\s*\d+.*?|å¼•å­|ç•ªå¤–.*?|å‰è¨€|åºè¨€|å°¾å£°|åè®°)<\/p>/g;
        
        tempContent = tempContent.replace(chapRegex, (match, title) => {
            chapIdx++;
            const curId = `toc-chap-${chapIdx}`;
            // å·¦ä¾§ç”Ÿæˆç›®å½•åˆ—è¡¨é¡¹
            tocHTML += `<div class="toc-item" onclick="jumpToChap('${curId}')">${title}</div>`;
            // ç»™æ­£æ–‡é‡Œçš„è¿™ä¸€è¡ŒåŠ ä¸Š id å’Œ é†’ç›®çš„æ’ç‰ˆ
            return `<p id="${curId}" style="font-weight:bold;color:var(--accent);font-size:1.3em;margin-top:1.5em;padding-bottom:10px;border-bottom:1px dashed #ddd;">${title}</p>`;
        });

        if(chapIdx === 0) {
            tocHTML = '<div style="padding:30px;text-align:center;color:#999;font-size:14px;line-height:1.6">ğŸ¤– æ™ºèƒ½æå–æœªå‘ç°ç« èŠ‚ã€‚<br><br>æœ¬ä¹¦å¯èƒ½æ˜¯çŸ­ç¯‡æ•£æ–‡ã€æœªåˆ†ç« çš„TXTï¼Œæˆ–æ˜¯æ’ç‰ˆæ¯”è¾ƒç‰¹æ®Šçš„æ–‡æ¡£ã€‚</div>';
        }
        document.getElementById('toc-list').innerHTML = tocHTML;
        // --- ç›®å½•æå–ç»“æŸ ---

        document.getElementById('reader-content').innerHTML = tempContent;
        setTimeout(()=>document.getElementById('reader-content').scrollTop=b.scroll,100);
        const ns=await Store.getAll('notes'); restoreHighlights(ns.filter(n=>n.bookId===b.id));
    }

    // ç›®å½•è·³è½¬åŠŸèƒ½
    window.jumpToChap = function(id) {
        const el = document.getElementById(id);
        if(el) {
            const reader = document.getElementById('reader-content');
            // è®¡ç®—è·³è½¬ä½ç½®ï¼Œå‡å»å¤´éƒ¨æ çš„é«˜åº¦å’Œä¸€ç‚¹ç•™ç™½
            reader.scrollTo({ top: el.offsetTop - 60, behavior: 'smooth' });
            // è·³è½¬åè‡ªåŠ¨å…³é—­ç›®å½•ä¾§è¾¹æ 
            document.getElementById('toc-sidebar').classList.remove('active');
        }
    }
    function closeReader(){document.getElementById('reader-overlay').classList.remove('active');refreshShelf();refreshTimeline()}

    // --- Restore Highlights ---
    function restoreHighlights(notes) {
        if(!notes || !notes.length) return;
        const root = document.getElementById('reader-content'); const content = root.innerHTML;
        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT, null, false);
        const textNodes = []; let node; while(node = walker.nextNode()) textNodes.push(node);
        notes.forEach(note => {
            if(content.includes(`window.openSidebarById('${note.id}')`)) return;
            for(let tn of textNodes) {
                const idx = tn.nodeValue.indexOf(note.quote);
                if(idx !== -1) {
                    try {
                        const range = document.createRange(); range.setStart(tn, idx); range.setEnd(tn, idx + note.quote.length);
                        const wrapper = document.createElement('mark'); wrapper.className = 'ai-mark'; wrapper.dataset.nid = note.id; wrapper.textContent = note.quote;
                        wrapper.onclick = (e) => { e.stopPropagation(); window.openSidebarById(note.id); };
                        range.deleteContents(); range.insertNode(wrapper); break;
                    } catch(e) {}
                }
            }
        });
    }

    // --- Selection ---
    document.addEventListener('selectionchange', () => {
        const s = window.getSelection(); const d = document.getElementById('floating-dock');
        if(!s.isCollapsed && document.getElementById('reader-content').contains(s.anchorNode)) d.classList.add('visible');
        else setTimeout(()=> { if(window.getSelection().isCollapsed) d.classList.remove('visible') }, 300);
    });

    const handleCreate = (e, mode) => {
        e.preventDefault(); e.stopPropagation();
        const s = window.getSelection(); if(s.isCollapsed) return showToast("âš ï¸ è¯·é€‰æ‹©æ–‡æœ¬");
        const range = s.getRangeAt(0).cloneRange(); const text = s.toString();
        if(!text.trim()) return showToast("âš ï¸ é€‰åŒºä¸ºç©º");
        createNoteWithSelection(range, text, mode);
    };
    ['mousedown','touchstart'].forEach(evt => { document.getElementById('btn-ai').addEventListener(evt, e => handleCreate(e, 'ai')); document.getElementById('btn-user').addEventListener(evt, e => handleCreate(e, 'user')); });

    async function createNoteWithSelection(range, text, mode) {
        const allNotes = await Store.getAll('notes');
        if(allNotes.find(n => n.bookId === currentBook.id && n.quote === text) && !confirm("âš ï¸ å·²æœ‰ç›¸åŒæ ‡è®°ï¼Œé‡å¤æ ‡è®°ï¼Ÿ")) {
             window.getSelection().removeAllRanges(); document.getElementById('floating-dock').classList.remove('visible'); return;
        }
        document.getElementById('floating-dock').classList.remove('visible'); const nid = 'n'+Date.now();
        try {
            const wrapper = document.createElement('mark'); wrapper.className = 'ai-mark'; wrapper.dataset.nid = nid; wrapper.innerText = text;
            wrapper.onclick = (e) => { e.stopPropagation(); window.openSidebarById(nid); };
            range.deleteContents(); range.insertNode(wrapper);
        } catch(e) {
            const anchor = document.createElement('span'); anchor.className = 'ai-anchor'; anchor.innerText = 'ğŸ“'; anchor.dataset.nid = nid;
            anchor.onclick = (e) => { e.stopPropagation(); window.openSidebarById(nid); }; range.collapse(true); range.insertNode(anchor);
        }
        window.getSelection().removeAllRanges();
        const note = { id:nid, bookId:currentBook.id, quote:text, time:Date.now(), messages:[], contextPre: "...", contextPost: "..." };
        await Store.put('notes', note);
        if(mode=='ai') triggerAI(note); else openSidebar(note);
    }

    // --- Chat & Timeline ---
    function openSidebar(n){activeNoteId=n.id;document.getElementById('sidebar').classList.add('active');document.getElementById('chat-quote').innerText=n.quote;renderChat(n.messages)}
    function renderChat(ms){
        const l=document.getElementById('chat-list'); l.innerHTML='';
        if(ms.length==0) l.innerHTML='<div style="text-align:center;color:#999;margin-top:20px;font-size:13px">âœ¨ æš‚æ— ç¬”è®°</div>';
        ms.forEach((m, idx)=>{
            const isAI = m.role=='ai';
            const actionsHTML = `
                <div class="msg-actions">
                    ${!isAI ? `<span class="action-link" onclick="editMsg(${idx})">âœï¸ ç¼–è¾‘</span>` : ''}
                    ${isAI && idx===ms.length-1 ? `<span class="action-link" onclick="retryAI()">ğŸ”„ é‡å†™</span>` : ''}
                    <span class="action-link danger" onclick="deleteMsg(${idx})">ğŸ—‘ï¸ åˆ é™¤</span>
                    <span class="action-link" onclick="safeCopy('${m.content.replace(/'/g,"\\'").replace(/\n/g," ")}')">ğŸ“„ å¤åˆ¶</span>
                </div>`;
            const d=document.createElement('div'); d.className=`msg-container ${m.role}`;
            d.innerHTML = `<div class="msg-bubble">${formatText(m.content)}</div>${actionsHTML}`;
            l.appendChild(d);
        });
        l.scrollTop=l.scrollHeight;
    }

    // --- Timeline Logic (Fixed Category & Filter) ---
    async function refreshTimeline(){
        const ns=await Store.getAll('notes'); const bs=await Store.getAll('books');
        const c=document.getElementById('timeline-content'); c.innerHTML='';
        const filterId = document.getElementById('timeline-filter').value;

        if(ns.length==0){c.innerHTML='<div style="text-align:center;color:#999;margin-top:20px">æš‚æ— ç¬”è®°</div>';return}
        
        // Group by Book
        const gs={};
        ns.forEach(n=>{
            if(filterId !== 'all' && n.bookId !== filterId) return; // Filter
            if(!gs[n.bookId]) gs[n.bookId]=[]; gs[n.bookId].push(n);
        });
        
        if(Object.keys(gs).length === 0) { c.innerHTML='<div style="text-align:center;color:#999;margin-top:20px">è¯¥ä¹¦ä¸‹æš‚æ— ç¬”è®°</div>'; return; }

        Object.keys(gs).forEach(bid=>{
            const b=bs.find(x=>x.id==bid);
            const g=document.createElement('div'); g.className='tl-book-group';
            // Collapsible Header
            g.innerHTML=`
                <div class="tl-header" onclick="this.parentElement.classList.toggle('collapsed')">
                    <span class="tl-title">ğŸ“– ${b?b.title:'æœªçŸ¥'} <small style="color:#999;font-weight:normal">(${gs[bid].length})</small></span>
                    <span class="tl-arrow">â–¼</span>
                </div>
                <div class="tl-notes-container"></div>
            `;
            const ct=g.querySelector('.tl-notes-container');
            
            // Render Notes
            gs[bid].sort((a,b)=>b.time-a.time).forEach(n=>{
                const d=document.createElement('div'); d.className='tl-note-item';
                d.innerHTML=`<div style="color:#666">"${n.quote}"</div><div style="font-size:12px;color:#999;margin-top:4px">${(n.messages[n.messages.length-1]?.content||'').slice(0,40)}...</div>`;
                initTimelineItem(d, n.id);
                d.onclick=async()=>{ if(isLongPress) return; const bk=await Store.get('books',n.bookId); if(bk){ switchTab('shelf'); openReader(bk); setTimeout(()=>openSidebar(n),500); } };
                ct.appendChild(d);
            });
            c.appendChild(g);
        });
    }

    // --- Actions ---
    let longPressTimer, isLongPress, targetNoteId;
    function initTimelineItem(el, nid) {
        const start = () => { isLongPress=false; longPressTimer=setTimeout(()=>{isLongPress=true;el.classList.add('long-pressed');if(navigator.vibrate)navigator.vibrate(50);showActionSheet(nid)},600); };
        const end = () => { clearTimeout(longPressTimer); setTimeout(()=>el.classList.remove('long-pressed'),300); };
        el.addEventListener('touchstart', start); el.addEventListener('touchend', end); el.addEventListener('mousedown', start); el.addEventListener('mouseup', end);
    }
    function showActionSheet(nid) { targetNoteId=nid; document.getElementById('as-mask').classList.add('active'); document.getElementById('action-sheet').classList.add('active'); 
        document.getElementById('as-del-btn').onclick=async()=>{ if(!targetNoteId)return; await Store.del('notes',targetNoteId); closeActionSheet(); refreshTimeline(); showToast("ğŸ—‘ï¸ å·²åˆ é™¤"); }; 
    }
    function closeActionSheet(){ document.getElementById('as-mask').classList.remove('active'); document.getElementById('action-sheet').classList.remove('active'); }

    // --- AI & Knowledge ---
    async function triggerAI(n) {
        if(!GS.key) return showToast("è¯·å…ˆè®¾ç½® API Key");
        openSidebar(n); const l=document.getElementById('chat-list');
        const loadDiv = document.createElement('div'); loadDiv.className='msg-container ai'; loadDiv.innerHTML=`<div class="msg-bubble"><div style="height:14px;width:100px" class="skeleton"></div></div>`;
        l.appendChild(loadDiv); l.scrollTop=l.scrollHeight;

        const memoryText = (currentBook.memories||[]).map((m,i)=>`${i+1}. ${m}`).join('\n');
        const systemPrompt = `${GS.persona}\nä¹¦æœ¬è®°å¿†ï¼š${memoryText}\nèƒŒæ™¯ï¼š${currentBook.context}`;
        const msgs = [ {role:'system', content: systemPrompt}, ...n.messages.map(m=>({role:m.role=='ai'?'assistant':'user', content:m.content})) ];
        if(n.messages.length===0) msgs.push({role:'user', content:`æˆ‘è¯»åˆ°äº†è¿™æ®µï¼š\n"${n.quote}"\n\nä½ æ€ä¹ˆçœ‹ï¼Ÿ`});

        let fullText = "";
        try {
            await callAPIStream(msgs, (chunk) => { fullText += chunk; loadDiv.innerHTML = `<div class="msg-bubble">${formatText(fullText)}<span class="cursor"></span></div>`; l.scrollTop = l.scrollHeight; });
            loadDiv.innerHTML = `<div class="msg-bubble">${formatText(fullText)}</div><div class="msg-actions"><span class="action-link" onclick="retryAI()">ğŸ”„ é‡å†™</span> <span class="action-link danger" onclick="deleteMsg(${n.messages.length})">ğŸ—‘ï¸ åˆ é™¤</span></div>`;
            n.messages.push({role:'ai', content:fullText, time:Date.now()}); await Store.put('notes', n);
        } catch(e) { loadDiv.innerHTML = `<div class="msg-bubble" style="color:red">Error: ${e.message}</div>`; }
    }
    async function callAPIStream(messages, onChunk) {
        const response = await fetch(`${GS.url}/chat/completions`, {method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GS.key}` }, body: JSON.stringify({ model: GS.model, messages: messages, stream: true })});
        if(!response.ok) throw new Error('API Error');
        const reader = response.body.getReader(); const decoder = new TextDecoder(); let buffer = '';
        while (true) {
            const {done, value} = await reader.read(); if (done) break;
            buffer += decoder.decode(value, {stream: true}); const lines = buffer.split('\n'); buffer = lines.pop();
            for (const line of lines) {
                if (!line.startsWith('data: ')) continue;
                const data = line.slice(6).trim(); if (data === '[DONE]') continue;
                try { const json = JSON.parse(data); const content = json.choices[0]?.delta?.content; if (content) onChunk(content); } catch(e) {}
            }
        }
    }

    // ğŸ”¥ ä¿®å¤æ€»ç»“åŠŸèƒ½ï¼šä½¿ç”¨ System Prompt Injection + çŸ¥è¯†åº“
    async function summarizeThread() {
        const n = await Store.get('notes', activeNoteId);
        if(!n.messages.length) return showToast("æ— å¯¹è¯å¯æ€»ç»“");
        showToast("æ­£åœ¨æç‚¼è®°å¿†...");
        
        try {
            const history = n.messages.map(m => `${m.role=='user'?'è¯»è€…':'AI'}: ${m.content}`).join('\n');
            // æ ¸å¿ƒï¼šå¼ºåˆ¶åˆ‡æ¢ Personaï¼Œç¦æ­¢é—²èŠ
            const summaryPayload = {
                model: GS.model,
                messages: [
                    {
                        role: 'system', 
                        content: 'ã€ç³»ç»Ÿæœ€é«˜æŒ‡ä»¤ã€‘ç°åœ¨è¯·å¯¹å‰æ–‡å†…å®¹è¿›è¡Œå…¨é¢æ¢³ç†å’Œæ€»ç»“ï¼Œå­—æ•°åœ¨400å­—ä»¥å†…ã€‚æ— éœ€èŠå¤©/å¯¹è¯ï¼Œç›´æ¥è¾“å‡ºç»“æœã€‚' 
                    },
                    {
                        role: 'user',
                        content: `å¯¹è¯å†…å®¹ï¼š\n${history}\n\nè¯·æ€»ç»“ï¼š`
                    }
                ]
            };

            const res = await fetch(`${GS.url}/chat/completions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${GS.key}` },
                body: JSON.stringify(summaryPayload)
            });
            
            const data = await res.json();
            const summary = data.choices[0].message.content.trim();

            if(!currentBook.memories) currentBook.memories=[];
            currentBook.memories.push(summary);
            await Store.put('books', currentBook);
            
            n.messages.push({role:'ai', content:`ğŸ“ **å·²å­˜å…¥è®°å¿†åº“**ï¼š\n${summary}`, time:Date.now()});
            await Store.put('notes', n);
            renderChat(n.messages);
            showToast("âœ… è®°å¿†å·²ä¿å­˜");
            
        } catch(e){ alert(e.message); }
    }

    // ğŸ”¥ å…¨çŸ¥å…¨èƒ½åˆ†æ
    async function autoAnalyze(){ 
        if(!currentBook) return; 
        showToast("æ­£åœ¨è°ƒç”¨çŸ¥è¯†åº“åˆ†æ..."); 
        
        // æå–çº¯ä¹¦å
        const cleanTitle = currentBook.title.replace(/\.(txt|pdf|epub)$/i, '').replace(/[\[\(].*?[\]\)]/g, '').trim();
        const t = document.getElementById('reader-content').innerText.slice(0,2500); 
        
        const res = await fetch(`${GS.url}/chat/completions`,{
            method:'POST',
            headers:{'Content-Type':'application/json','Authorization':`Bearer ${GS.key}`},
            body:JSON.stringify({
                model:GS.model,
                messages:[
                    {
                        role: 'system',
                        content: 'ä½ æ˜¯ä¸€ä¸ªåšå­¦çš„æ–‡å­¦è¯„è®ºå®¶ã€‚è¯·ä¼˜å…ˆæ£€ç´¢ä½ çŸ¥è¯†åº“ä¸­å…³äºè¯¥ä¹¦çš„ä¿¡æ¯ã€‚å¦‚æœä¸çŸ¥é“è¿™æœ¬ä¹¦ï¼Œå†æ ¹æ®ç”¨æˆ·æä¾›çš„å¼€å¤´è¿›è¡Œæ¨æ–­ã€‚'
                    },
                    {
                        role:'user',
                        content:`è¯·åˆ†æä¹¦ç±ã€Š${cleanTitle}ã€‹ã€‚\nå¦‚æœçŸ¥é“è¿™æœ¬ä¹¦ï¼Œè¯·ç›´æ¥ä»‹ç»å…¶æ ¸å¿ƒå‰§æƒ…ã€äººç‰©å…³ç³»å’Œçœ‹ç‚¹ï¼ˆ300å­—ï¼‰ã€‚\nå¦‚æœä¸çŸ¥é“ï¼Œè¯·æ ¹æ®ä»¥ä¸‹å¼€å¤´è¿›è¡Œæ¨æ–­ï¼š\n${t}`
                    }
                ]
            })
        }).then(r=>r.json()); 
        
        document.getElementById('current-book-context').value = res.choices[0].message.content; 
        saveBookConfig(); 
        showToast("âœ… åˆ†æå®Œæˆ"); 
    }

    // Utils
    function formatText(t){ return t.replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g,'<br>'); }
    function showToast(msg) { const t = document.getElementById('toast'); t.innerText = msg; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2000); }
    function safeCopy(text) { const ta = document.createElement("textarea"); ta.value = text; ta.style.position = 'fixed'; ta.style.left = '-9999px'; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); showToast("âœ… å·²å¤åˆ¶"); } catch (e) {} document.body.removeChild(ta); }
    async function sendMsg(tai) { const i=document.getElementById('chat-input'); const t=i.value.trim(); const n=await Store.get('notes', activeNoteId); if(t){ n.messages.push({role:'user',content:t,time:Date.now()}); await Store.put('notes',n); renderChat(n.messages); i.value=''; } if(tai) triggerAI(n); }
    async function deleteMsg(idx) { if(!confirm('åˆ é™¤ï¼Ÿ'))return; const n = await Store.get('notes', activeNoteId); n.messages.splice(idx, 1); await Store.put('notes', n); renderChat(n.messages); }
    async function editMsg(idx) { const n = await Store.get('notes', activeNoteId); const t = prompt("Edit:", n.messages[idx].content); if(t!==null){ n.messages[idx].content=t; await Store.put('notes', n); renderChat(n.messages); } }
    async function retryAI() { const n = await Store.get('notes', activeNoteId); if(n.messages.at(-1).role==='ai'){ n.messages.pop(); await Store.put('notes', n); renderChat(n.messages); triggerAI(n); } }
    function openBookConfig(){if(!currentBook)return;document.getElementById('current-book-context').value=currentBook.context||'';renderMemories();document.getElementById('book-config-modal').style.display='flex';}
    function saveBookConfig(){currentBook.context=document.getElementById('current-book-context').value;Store.put('books',currentBook);}
    function renderMemories(){ const list = document.getElementById('memory-list'); list.innerHTML = ''; (currentBook.memories || []).forEach((m, i) => { const div = document.createElement('div'); div.innerHTML = `<div style="background:#fff8e1;border-left:4px solid #f1c40f;padding:10px;margin-bottom:10px;position:relative"><div contenteditable="true" onblur="updateMemory(${i}, this.innerText)">${m.replace(/</g,'&lt;')}</div><div style="position:absolute;top:0;right:0;padding:5px;color:red;font-weight:bold;cursor:pointer" onclick="deleteMemory(${i})">Ã—</div></div>`; list.appendChild(div.firstChild); }); }
    async function updateMemory(idx, text){ currentBook.memories[idx] = text; await Store.put('books', currentBook); }
    async function deleteMemory(idx){ if(confirm("åˆ é™¤?")){ currentBook.memories.splice(idx, 1); await Store.put('books', currentBook); renderMemories(); } }
    async function addEmptyMemory(){ if(!currentBook.memories) currentBook.memories=[]; currentBook.memories.push("æ–°è®°å¿†..."); await Store.put('books', currentBook); renderMemories(); }
    async function fetchModels(){showToast("åŠ è½½æ¨¡å‹...");try{const r=await fetch(`${GS.url}/models`,{headers:{'Authorization':`Bearer ${GS.key}`}});const d=await r.json();const s=document.getElementById('model-select');s.innerHTML='';(d.data||d).forEach(m=>s.add(new Option(m.id,m.id)));showToast("âœ… æˆåŠŸ")}catch(e){alert(e.message)}}
    
    // File
    document.getElementById('file-in').addEventListener('change', async e=>{const f=e.target.files[0];if(!f)return;showToast("æ­£åœ¨è§£æ...");try{let c='',t=f.name.split('.').pop().toLowerCase();if(t=='txt')c=formatTxt(await readFile(f));else if(t=='pdf')c=formatPdf(await parsePdf(f));else if(t=='epub')c=formatTxt(await parseEpub(f));await Store.put('books',{id:Date.now().toString(),title:f.name,type:t,content:c,scroll:0,context:'',memories:[],color:`hsl(${Math.random()*360},60%,70%)`});refreshShelf(); openBookConfig();}catch(x){alert(x.message)}});
    function readFile(f){return new Promise(r=>{const reader=new FileReader();reader.onload=e=>{const decoder=new TextDecoder(GS.encoding||'utf-8');r(decoder.decode(e.target.result));};reader.readAsArrayBuffer(f);})}
    function readArr(f){return new Promise(r=>{const d=new FileReader();d.onload=e=>r(e.target.result);d.readAsArrayBuffer(f)})}
    async function parsePdf(f){const p=await pdfjsLib.getDocument({data:await readArr(f)}).promise;let t='';for(let i=1;i<=p.numPages;i++)t+=(await(await p.getPage(i)).getTextContent()).items.map(s=>s.str).join(' ')+'\n\n';return formatPdf(t)}
    async function parseEpub(f){const z=await JSZip.loadAsync(await readArr(f));const p=new DOMParser();let t='';for(let k in z.files)if(k.match(/\.x?html$/))t+=p.parseFromString(await z.file(k).async('string'),'text/html').body.innerText+'\n\n';return t}
    function formatTxt(t){return t.split('\n').filter(s=>s.trim()).map(s=>`<p>${s}</p>`).join('')}
    function formatPdf(t){return t.split('\n').map(s=>s.trim()?`<p>${s}</p>`:'<br>').join('')}
    
    // System
    function saveGS(){GS.key=document.getElementById('api-key').value;GS.url=document.getElementById('api-url').value;GS.model=document.getElementById('model-select').value;GS.persona=document.getElementById('default-persona').value;GS.encoding=document.getElementById('encoding-select').value;localStorage.setItem('sr_key',GS.key);localStorage.setItem('sr_url',GS.url);localStorage.setItem('sr_model',GS.model);localStorage.setItem('sr_persona',GS.persona);localStorage.setItem('sr_encoding',GS.encoding);}
    function delBook(e,id){e.stopPropagation();if(confirm('åˆ é™¤ä¹¦å’Œç¬”è®°ï¼Ÿ'))Store.del('books',id).then(refreshShelf)}
    function switchTab(t){document.querySelectorAll('.tab-item').forEach(e=>e.classList.remove('active'));document.querySelectorAll('.view-page').forEach(e=>e.classList.remove('active'));const i={'shelf':0,'timeline':1,'settings':2}[t];document.querySelectorAll('.tab-item')[i].classList.add('active');document.getElementById(`view-${t}`).classList.add('active');if(t=='timeline')refreshTimeline()}
    let st; function handleScroll(){ if(st)return; st=setTimeout(()=>{st=null; if(currentBook){currentBook.scroll=document.getElementById('reader-content').scrollTop;Store.put('books',currentBook)}},1000); }
    window.addEventListener('beforeunload',()=>{if(currentBook){currentBook.scroll=document.getElementById('reader-content').scrollTop;Store.put('books',currentBook)}});
    
    initDB();
</script>
</body>
</html>



